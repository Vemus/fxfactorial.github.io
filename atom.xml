<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"
    xmlns:dc="http://purl.org/dc/elements/1.1/">
    <channel>
        <title>hyegar.com - All posts</title>
        <link>http://hyegar.com</link>
        <description><![CDATA[Personal blog of Edgar Aroutiounian]]></description>
        <atom:link href="http://hyegar.com/atom.xml" rel="self"
                   type="application/rss+xml" />
        <lastBuildDate>Sun, 17 Jul 2016 00:00:00 UT</lastBuildDate>
        <item>
    <title>Intermediate js_of_ocaml</title>
    <link>http://hyegar.com/2016/07/17/js-of-ocaml-usage/index.html</link>
    <description><![CDATA[<p>This post is mainly aimed at intermediate level users of <code>js_of_ocaml</code>, the <code>OCaml</code> to <code>JavaScript</code> compiler and at improving the sad state of documentation for <code>js_of_ocaml</code>. (Plus I’m interviewing for jobs, hire me!, and wanted to use both OCaml, JavaScript while preparing for interviews)</p>
<h1 id="ocaml-typing-of-javascript-uses-ppx">OCaml typing of JavaScript (Uses PPX)</h1>
<p>Say we want to express some algorithms in OCaml but using JavaScript as the runtime execution language/environment. Let’s start with our main data structure, a tree node.</p>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span> <span class="at">TreeNode</span>(value) <span class="op">{</span>
  <span class="kw">this</span>.<span class="at">value</span> <span class="op">=</span> value<span class="op">;</span>
  <span class="kw">this</span>.<span class="at">left</span> <span class="op">=</span> <span class="kw">this</span>.<span class="at">right</span> <span class="op">=</span> <span class="kw">null</span><span class="op">;</span>
<span class="op">}</span></code></pre></div>
<p>Our OCaml version will be:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">class</span> <span class="kw">type</span> [&#39;data] tree_node = <span class="kw">object</span>
  <span class="kw">method</span> value : &#39;data Js<span class="kw">.</span>prop
  <span class="kw">method</span> left : &#39;data tree_node Js<span class="kw">.</span>t Js<span class="kw">.</span>prop
  <span class="kw">method</span> right : &#39;data tree_node Js<span class="kw">.</span>t Js<span class="kw">.</span>prop
<span class="kw">end</span></code></pre></div>
<p>Note that there is a small thing about typing the nullability of the left, right fields, I will return to this at the end of the blog post and it was done for convenience.</p>
<p>So explanations:</p>
<ol start="0" style="list-style-type: decimal">
<li>We are creating a <code>class type</code>, this just describes the object, how we describe it is key.</li>
<li>The <code>'data</code> is a type variable and lets us use any kind of type for the value in this node.</li>
<li>OCaml objects only expose methods to the outside world, so properties need <code>Js.prop</code>, this lets us read and write to this field. We can control it to be read only by instead using <code>Js.readonly_prop</code> or even write only with <code>Js.writeonly_prop</code>.</li>
<li>Methods <code>left</code>, <code>right</code> are also properties. Read the signature from right to left, aka <code>left</code> is a JavaScript read or write property which has a JavaScript object typed as <code>tree_node</code> and parameterized with the <code>'data</code> type variable. Aka tree_nodes of <code>string</code> or <code>int</code> or whatever the type of <code>'data</code> is.</li>
</ol>
<p>Now we need to provide a way to make this object.</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> __hidden__ =
  Js<span class="kw">.</span>Unsafe<span class="kw">.</span>pure_js_expr <span class="st">&quot;function TreeNode(value) {</span><span class="ch">\</span>
<span class="st">                          this.value = value; </span><span class="ch">\</span>
<span class="st">                          this.left = this.right = null;}&quot;</span></code></pre></div>
<p>This is the JavaScript we’ll be using, essentially. Do note that the field names match up, this is important. Now we provide a constructor function:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> node : (&#39;data -&gt; &#39;data tree_node Js<span class="kw">.</span>t) Js<span class="kw">.</span>constr = __hidden__</code></pre></div>
<p>This <code>node</code> constructor says that its a special JavaScript constructor that will invoke <code>__hidden__</code> with <code>new</code> and such that it expects one argument. An example is:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> root = <span class="kw">new</span>%js node <span class="st">&quot;Hello&quot;</span></code></pre></div>
<p>We can also make specialized constructors,</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> node_from_int : (<span class="dt">int</span> -&gt; <span class="dt">int</span> tree_node Js<span class="kw">.</span>t) Js<span class="kw">.</span>constr = __hidden__</code></pre></div>
<p>and a simple usage:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> () =
  <span class="kw">let</span> root = <span class="kw">new</span>%js node <span class="st">&quot;Hello&quot;</span> <span class="kw">in</span>
  root##.left := <span class="kw">new</span>%js node <span class="st">&quot;Left side&quot;</span>;
  root##.left##.left := <span class="kw">new</span>%js node <span class="st">&quot;Grand Kid&quot;</span>;

  <span class="co">(* Note that this just prints the raw object representation of the</span>
<span class="co">  field value *)</span>
  Firebug<span class="kw">.</span>console##log root##.left##.left##.value;

  <span class="co">(* This shows the value as expected *)</span>
  print_endline root##.left##.left##.value</code></pre></div>
<p>You can compile and run it on node with: (Assuming file name is <code>trees_in_js.ml</code>)</p>
<pre class="shell"><code>$ ocamlfind ocamlc -package js_of_ocaml.ppx -linkpkg trees_in_js.ml
$ js_of_ocaml a.out -o T.js
$ node T.js</code></pre>
<p>And you should get something like the following printed out:</p>
<pre class="shell"><code>h { t: 0, c: &#39;Grand Kid&#39;, l: 9 }
Grand Kid</code></pre>
<h1 id="depth-first-search-level-order-traversal-complete-examples">Depth First Search, Level order traversal complete examples</h1>
<p>Now here’s an example of a preorder depth first search and level order traversal.</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">class</span> <span class="kw">type</span> [&#39;data] tree_node = <span class="kw">object</span>
  <span class="kw">method</span> value : &#39;data Js<span class="kw">.</span>prop
  <span class="kw">method</span> left : &#39;data tree_node Js<span class="kw">.</span>t Js<span class="kw">.</span>prop
  <span class="kw">method</span> right : &#39;data tree_node Js<span class="kw">.</span>t Js<span class="kw">.</span>prop
<span class="kw">end</span>

<span class="kw">let</span> node : (&#39;data -&gt; &#39;data tree_node Js<span class="kw">.</span>t) Js<span class="kw">.</span>constr = __hidden__

<span class="kw">let</span> depth_first_search starting_node =
  <span class="kw">let</span> stack = Stack<span class="kw">.</span>create () <span class="kw">in</span>
  Stack<span class="kw">.</span>push starting_node stack;
  <span class="kw">while</span> not (Stack<span class="kw">.</span>is_empty stack) <span class="kw">do</span>
    <span class="kw">let</span> iter_node = Stack<span class="kw">.</span>pop stack <span class="kw">in</span>

    Printf<span class="kw">.</span>sprintf <span class="st">&quot;%s &quot;</span> iter_node##.value
    |&gt; print_string;

    <span class="kw">if</span> Js<span class="kw">.</span>Opt<span class="kw">.</span>return iter_node##.right |&gt; Js<span class="kw">.</span>Opt<span class="kw">.</span>test
    <span class="kw">then</span> Stack<span class="kw">.</span>push iter_node##.right stack;

    <span class="kw">if</span> Js<span class="kw">.</span>Opt<span class="kw">.</span>return iter_node##.left |&gt; Js<span class="kw">.</span>Opt<span class="kw">.</span>test
    <span class="kw">then</span> Stack<span class="kw">.</span>push iter_node##.left stack

  <span class="kw">done</span>

<span class="kw">let</span> level_order starting_node =
  <span class="kw">let</span> q = Queue<span class="kw">.</span>create () <span class="kw">in</span>
  Queue<span class="kw">.</span>add starting_node q;

  <span class="kw">while</span> not (Queue<span class="kw">.</span>is_empty q) <span class="kw">do</span>
    <span class="kw">let</span> pop = Queue<span class="kw">.</span>pop q <span class="kw">in</span>
    Printf<span class="kw">.</span>sprintf <span class="st">&quot;%s &quot;</span> pop##.value
    |&gt; print_string;

    <span class="kw">if</span> Js<span class="kw">.</span>Opt<span class="kw">.</span>(return pop##.left |&gt; test)
    <span class="kw">then</span> Queue<span class="kw">.</span>push pop##.left q;

    <span class="kw">if</span> Js<span class="kw">.</span>Opt<span class="kw">.</span>(return pop##.right |&gt; test)
    <span class="kw">then</span> Queue<span class="kw">.</span>push pop##.right q

  <span class="kw">done</span>

<span class="kw">let</span> () =
  <span class="kw">let</span> root = <span class="kw">new</span>%js node <span class="st">&quot;F&quot;</span> <span class="kw">in</span>
  root##.left := <span class="kw">new</span>%js node <span class="st">&quot;B&quot;</span>;
  root##.right := <span class="kw">new</span>%js node <span class="st">&quot;G&quot;</span>;
  root##.right##.right := <span class="kw">new</span>%js node <span class="st">&quot;I&quot;</span>;
  root##.left##.left := <span class="kw">new</span>%js node <span class="st">&quot;A&quot;</span>;
  root##.left##.right := <span class="kw">new</span>%js node <span class="st">&quot;D&quot;</span>;
  root##.left##.right##.left := <span class="kw">new</span>%js node <span class="st">&quot;C&quot;</span>;
  root##.left##.right##.right := <span class="kw">new</span>%js node <span class="st">&quot;E&quot;</span>;
  root##.right##.right##.left := <span class="kw">new</span>%js node <span class="st">&quot;H&quot;</span>;

  depth_first_search root |&gt; print_newline;
  level_order root |&gt; print_newline</code></pre></div>
<p>and compile it just like given earlier in the blog post. Shameless plug, you can also turn it into an executable with a feature I added to the <code>js_of_ocaml</code> compiler,</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml">$ ocamlfind ocamlc -package js_of_ocaml.ppx -linkpkg trees_in_js.ml
$ js_of_ocaml --custom-header=&#39;#!/usr/bin/env node&#39; a.out -o T<span class="kw">.</span>js
$ chmod +x T<span class="kw">.</span>js
$ /T<span class="kw">.</span>js</code></pre></div>
<p>Yay, we used the resources of two programming languages standard libaries in one program!</p>
<p>Now we can return to why the typing of the <code>class type</code> matters. The fully correct typing of <code>tree_node</code> is:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">class</span> <span class="kw">type</span> [&#39;data] tree_node = <span class="kw">object</span>
  <span class="kw">method</span> value : &#39;data Js<span class="kw">.</span>prop
  <span class="kw">method</span> left : &#39;data tree_node Js<span class="kw">.</span>t Js<span class="kw">.</span>Opt<span class="kw">.</span>t Js<span class="kw">.</span>prop
  <span class="kw">method</span> right : &#39;data tree_node Js<span class="kw">.</span>t Js<span class="kw">.</span>Opt<span class="kw">.</span>t Js<span class="kw">.</span>prop
<span class="kw">end</span></code></pre></div>
<p>Notice the addition of <code>Js.Opt.t</code>. Since the <code>left</code>, <code>right</code> are nullable, we should capture that in the OCaml API, this however does force us to use <code>Js.Opt</code> and so we’d have to do things like:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml">root##.left := <span class="kw">new</span>%js node <span class="st">&quot;Left side&quot;</span> |&gt; Js<span class="kw">.</span>Opt<span class="kw">.</span>return;</code></pre></div>
<p>When trying to set the field, etc. But since we didn’t expose that nullability of the field in the type signature, the <code>depth_first_search</code> code needs to check if the field is indeed <code>null</code>, which would have been otherwise forced by the type system had we used <code>Js.Opt</code>, aka:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">if</span> Js<span class="kw">.</span>Opt<span class="kw">.</span>return iter_node##.right |&gt; Js<span class="kw">.</span>Opt<span class="kw">.</span>test
<span class="kw">then</span> Stack<span class="kw">.</span>push iter_node##.right stack;</code></pre></div>
<p>These are tradeoffs that you can make in your own usage.</p>
<p>I hope this makes it easier for you to use OCaml, JavaScript together.</p>]]></description>
    <pubDate>Sun, 17 Jul 2016 00:00:00 UT</pubDate>
    <guid>http://hyegar.com/2016/07/17/js-of-ocaml-usage/index.html</guid>
    <dc:creator>Edgar Aroutiounian</dc:creator>
</item>
<item>
    <title>Using system threads with Lwt</title>
    <link>http://hyegar.com/2016/05/21/using-lwt-preemptive/index.html</link>
    <description><![CDATA[<p>This blog post shows you how to use real system threads in OCaml by using <code>Lwt</code>, <code>Lwt_preemptive</code>.</p>
<h1 id="note">!!Note!!</h1>
<p>While this shows system threads being used, only one is will actually be running at any given point in time (Think this akin to Python’s single threadedness, still useful to use threads if bottleneck are IO)</p>
<h1 id="common-complaint-about-multicore">Common complaint about multicore</h1>
<p>A common complaint about OCaml is the lack of true parallelism, about the single threadedness of the runtime. This is true but its not like <code>OCaml</code> programmers don’t have solutions some solutions. Here’s an easy example that you can instantly use in your coding.</p>
<h1 id="setup">Setup</h1>
<p>First we will need some way to verify that our system threads are actually working, we’ll use some math equation to purposefully cause CPU load. Here’s the <code>Sieve Of Eratosthenes</code> Algorithm that I copied from <a href="http://www.scriptol.com/programming/sieve.php#ocaml">here</a>.</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="ot">open</span> List

<span class="kw">type</span> integer = <span class="dt">Int</span> <span class="kw">of</span> <span class="dt">int</span>
<span class="kw">let</span> number_two = <span class="dt">Int</span>(<span class="dv">2</span>)
<span class="kw">let</span> number_zero = <span class="dt">Int</span>(<span class="dv">0</span>)
<span class="kw">let</span> is_less_than_two (<span class="dt">Int</span> n) = n &lt; <span class="dv">2</span>
<span class="kw">let</span> incr (<span class="dt">Int</span> n) = <span class="dt">Int</span>(n + <span class="dv">1</span>)
<span class="kw">let</span> decr (<span class="dt">Int</span> n) = <span class="dt">Int</span>(n - <span class="dv">1</span>)
<span class="kw">let</span> is_number_zero (<span class="dt">Int</span> n) = n = <span class="dv">0</span>

<span class="kw">let</span> iota n =
  <span class="kw">let</span> <span class="kw">rec</span> loop curr counter =
    <span class="kw">if</span> is_less_than_two counter <span class="kw">then</span> []
    <span class="kw">else</span> curr::(loop (incr curr) (decr counter))
  <span class="kw">in</span>
  loop number_two n

<span class="kw">let</span> sieve lst =
  <span class="kw">let</span> <span class="kw">rec</span> choose_pivot = <span class="kw">function</span>
    | [] -&gt; []
    | car::cdr <span class="kw">when</span> is_number_zero car -&gt;
      car::(choose_pivot cdr)
    | car::cdr -&gt;
      car::(choose_pivot (do_sieve car (decr car) cdr))

  <span class="kw">and</span> do_sieve step current lst =
    <span class="kw">match</span> lst <span class="kw">with</span>
    | [] -&gt; []
    | car::cdr -&gt;
      <span class="kw">if</span> is_number_zero current
      <span class="kw">then</span> number_zero::(do_sieve step (decr step) cdr)
      <span class="kw">else</span> car::(do_sieve step (decr current) cdr)
  <span class="kw">in</span>
  choose_pivot lst

<span class="kw">let</span> is_prime n =
  <span class="kw">match</span> rev (sieve (iota n)) <span class="kw">with</span>
    x::_ -&gt; not (is_number_zero x)</code></pre></div>
<p>Now our <code>Lwt</code>, <code>Lwt_preemptive</code> code:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="ot">open</span> Lwt<span class="kw">.</span>Infix

<span class="kw">let</span> do_example port =
  <span class="kw">let</span> address = Unix<span class="kw">.</span>(<span class="dt">ADDR_INET</span> (inet_addr_loopback, port)) <span class="kw">in</span>
  Lwt_io<span class="kw">.</span>establish_server address (<span class="kw">fun</span> (tcp_in, tcp_out) -&gt;
      () |&gt; Lwt_preemptive<span class="kw">.</span>detach (<span class="kw">fun</span> () -&gt;
          <span class="kw">while</span> <span class="kw">true</span> <span class="kw">do</span>
            ignore (is_prime (<span class="dt">Int</span> port))
          <span class="kw">done</span>
        )
      |&gt; Lwt<span class="kw">.</span>ignore_result
    )
  |&gt; ignore |&gt; Lwt<span class="kw">.</span>return

<span class="kw">let</span> () =
  <span class="kw">let</span> <span class="kw">rec</span> forever () = fst (Lwt<span class="kw">.</span>wait ()) &gt;&gt;= forever <span class="kw">in</span>
  Lwt_preemptive<span class="kw">.</span>init <span class="dv">5</span> <span class="dv">10</span> ignore;
  ([<span class="dv">2000</span>; <span class="dv">2001</span>; <span class="dv">2002</span>; <span class="dv">2003</span>; <span class="dv">2004</span>]
   |&gt; Lwt_list<span class="kw">.</span>iter_p do_example &gt;&gt;= forever)
  |&gt; Lwt_main<span class="kw">.</span>run</code></pre></div>
<p>The code that runs inside the callback to <code>Lwt_io.establish_server</code> uses <code>Lwt_preemptive.detach</code>, this creates a new system thread whenever there is something that connects on ports <code>[2000; 2001; 2002; 2003; 2004]</code>. You don’t have to call <code>Lwt_preemptive.init</code> since detach will do it anyway, but I am doing it to ensure that at least 5 threads are made with 10 being the max.</p>
<p>We compile it with:</p>
<pre class="shell"><code>$ ocamlfind ocamlopt -thread -package lwt.unix,lwt.preemptive test_case.ml -linkpkg -o TEST_CASE</code></pre>
<p>And we test it by starting up <code>./TEST_CASE</code>, opening <code>htop</code> and finding <code>TEST_CASE</code> (hit <code>t</code> in htop to see a tree based process view) and running <code>socat STDIN TCP:localhost:&lt;some_port&gt;</code>, where <code>&lt;some_port&gt;</code> is a number in our list of ports (remember <code>[2000; 2001; 2002; 2003; 2004]</code>).</p>
<p>Thus we see in <code>htop</code> the CPU % utilization move for each of the threads of <code>TEST_CASE</code>.</p>
<p>Success! Real system threads.</p>]]></description>
    <pubDate>Sat, 21 May 2016 00:00:00 UT</pubDate>
    <guid>http://hyegar.com/2016/05/21/using-lwt-preemptive/index.html</guid>
    <dc:creator>Edgar Aroutiounian</dc:creator>
</item>
<item>
    <title>Simple timeout usage</title>
    <link>http://hyegar.com/2016/03/22/simple-timeouts/index.html</link>
    <description><![CDATA[<p>I wanted to use a timeout in OCaml for some shell coding but I didn’t want to introduce a big dependency on <code>Lwt</code>. After some googling I found <a href="https://www.reddit.com/r/ocaml/comments/3qapbv/question_about_writing_a_timeout_function_and_the/">this</a></p>
<p>Here’s my take on the timeout function, basically its the same but I push everything into the timeout function itself and use labeled args along a callback for when the timeout goes off.</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> timeout ?(on_timeout = <span class="kw">fun</span> () -&gt; ()) ~arg ~timeout ~default_value f =
  <span class="kw">let</span> <span class="ot">module</span> Wrapper = <span class="kw">struct</span> <span class="kw">exception</span> <span class="dt">Timeout</span> <span class="kw">end</span> <span class="kw">in</span>
  <span class="kw">let</span> sigalrm_handler = Sys<span class="kw">.</span><span class="dt">Signal_handle</span> (<span class="kw">fun</span> _ -&gt; raise Wrapper<span class="kw">.</span><span class="dt">Timeout</span>) <span class="kw">in</span>
  <span class="kw">let</span> old_behavior = Sys<span class="kw">.</span>signal Sys<span class="kw">.</span>sigalrm sigalrm_handler <span class="kw">in</span>
  <span class="kw">let</span> reset_sigalrm () = Sys<span class="kw">.</span>set_signal Sys<span class="kw">.</span>sigalrm old_behavior <span class="kw">in</span>
  ignore (Unix<span class="kw">.</span>alarm timeout);
  <span class="kw">try</span>
    <span class="kw">let</span> res = f arg <span class="kw">in</span>
    reset_sigalrm ();
    res
  <span class="kw">with</span> exc -&gt;
    reset_sigalrm ();
    <span class="kw">if</span> exc = Wrapper<span class="kw">.</span><span class="dt">Timeout</span>
    <span class="kw">then</span> (on_timeout (); default_value)
    <span class="kw">else</span> raise exc</code></pre></div>
<p>and you can can use it like so:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml">Sys<span class="kw">.</span>command
|&gt; timeout 
   ~arg:<span class="st">&quot;sleep 3&quot;</span> 
   ~timeout:<span class="dv">2</span> 
   ~default_value:(<span class="dv">-1</span>) 
   ~on_timeout:(<span class="kw">fun</span> () -&gt; print_endline <span class="st">&quot;func timed out&quot;</span>)</code></pre></div>
<p>You might notice that your wrapped function only gets one arg, so how can we use this timeout wrapper on functions that take more than one argument? By currying and using a dummy arg of unit.</p>
<p>Example:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> () =
  <span class="kw">let</span> partialed first second third () = first + second + third <span class="kw">in</span>
  timeout ~arg:() ~timeout:<span class="dv">4</span> ~default_value:(<span class="dv">-1</span>) (partialed <span class="dv">1</span> <span class="dv">2</span> <span class="dv">3</span>)
  |&gt; ignore</code></pre></div>
<p>I’ve added this to my <code>podge</code> library found <a href="http://github.com/fxfactorial/podge">here</a>, a collection of useful utility functions.</p>]]></description>
    <pubDate>Tue, 22 Mar 2016 00:00:00 UT</pubDate>
    <guid>http://hyegar.com/2016/03/22/simple-timeouts/index.html</guid>
    <dc:creator>Edgar Aroutiounian</dc:creator>
</item>
<item>
    <title>Building xen-arm-builder from source</title>
    <link>http://hyegar.com/2016/03/15/building-xen-arm-from-source/index.html</link>
    <description><![CDATA[<p>I’m in Morocco for the first <a href="http://marrakech2016.mirage.io/">mirageos</a> hackathon. One of the things I’ve done here is build <a href="https://github.com/mirage/xen-arm-builder">xen-arm-builder</a> from source and it was a big challenge. Here’s my general notes and pointers to help you get over this hump. I assume you know what mirageos/xen are.</p>
<p>Much MUCH thanks to <a href="http://roscidus.com/blog/">Thomas Leonard</a> and <a href="http://somerandomidiot.com/">Mindy Preston</a> for lending me a cubieboard2 and helping me with all the debugging, compiling issues; wouldn’t have been able to do it without them.</p>
<h1 id="machine-setup">Machine Setup</h1>
<p>I did this on Ubuntu 15 and was deploying to a <a href="http://cubieboard.org/2013/06/19/cubieboard2-is-here/">cubieboard2</a>.</p>
<h1 id="example-workflow">Example Workflow</h1>
<p>Assuming that you are connecting the cubieboard2 to your laptop over a serial connection then you can get a shell on the machine with</p>
<pre class="shell"><code>$ screen -h 10000 /dev/ttyUSB0 115200</code></pre>
<p>Then say you are using <a href="https://github.com/mirage/mirage-skeleton">mirage-skeleton</a>, here’s an example flow.</p>
<pre class="shell"><code>$ git clone https://github.com/mirage/mirage-skeleton
$ cd mirage-skeleton
$ make configure MODE=xen
$ cd console
$ make
$ sudo xl create console.xe</code></pre>
<p>Yay Unikernel on Cubieboard2!</p>
<h1 id="troublesome-issues">Troublesome issues</h1>
<p>I had many, many issues in building the code from source, here are some troubleshooting steps that might help you as well.</p>
<ol start="0" style="list-style-type: decimal">
<li>Be sure to have fast internet because building from source including making a clone of the Linux source, ouch.</li>
<li><code>OPAMVERBOSE=1 opam &lt;anything&gt;</code> is incredibly useful.</li>
<li>Ubuntu 15 will install a <code>gcc-5.0</code> version of the cross-compiler, be sure to do <code>make build CC=arm-linux-gnueabihf-gcc-4.8</code> instead of a plain <code>make build</code>.</li>
<li>Be sure to <strong>not</strong> use the <code>4.02.0</code> compiler, the cubieboard2 is super slow and that OCaml compiler had a performance bug, use the <code>4.02.3</code> compiler instead.</li>
<li>Check <code>top</code> to see some kind of xp binary, it eats the CPU and that really slows down compilation, best to kill them.</li>
<li>Do make sure that the time on the machine is correct, otherwise you’ll have weird hanging by opam which will seem like its building but actually its just stuck on a timing issue, aka be sure to do: <code>sudo ntpdate uk.pool.ntp.org</code> before doing anything with mirage/opam/aptitude.</li>
<li>If you get odd errors like:</li>
</ol>
<pre class="shell"><code>Parsing config from console.xl
xc: error: panic: xc_dom_core.c:185: failed to open file: No such file or directory: Internal error
libxl: error: libxl_dom.c:377:libxl__build_pv: xc_dom_kernel_file failed: No such file or directory
libxl: error: libxl_create.c:1022:domcreate_rebuild_done: cannot
(re-)build domain: -3</code></pre>
<p>Then check that the libraries are correctly set in <code>/usr/lib</code>, check with</p>
<pre class="shell"><code>$ sudo strace -e open xl create console.xl</code></pre>
<p>and either <code>cp</code> or <code>ln</code> them correctly.</p>
<ol start="7" style="list-style-type: decimal">
<li>I recommend just installing all the <code>depopts</code> of all the mirage projects, there are some bugs in mirage opam files that don’t install other needed packages.</li>
</ol>]]></description>
    <pubDate>Tue, 15 Mar 2016 00:00:00 UT</pubDate>
    <guid>http://hyegar.com/2016/03/15/building-xen-arm-from-source/index.html</guid>
    <dc:creator>Edgar Aroutiounian</dc:creator>
</item>
<item>
    <title>A Domain Generating Algorithm in OCaml</title>
    <link>http://hyegar.com/2016/03/07/dga-padcrypt-ocaml/index.html</link>
    <description><![CDATA[<p>Scrolling through twitter I saw someone mention something about the padcrypt <a href="https://en.wikipedia.org/wiki/Domain_generation_algorithm">dga</a>. Basically it generates random ish domain names.</p>
<p>Here’s an <code>OCaml</code> reimplementation of the Python code written <a href="http://johannesbader.ch/2016/03/the-dga-of-padcrypt/">here</a>.</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="ot">module</span> D = CalendarLib<span class="kw">.</span><span class="dt">Date</span>

<span class="kw">let</span> tlds = [|<span class="st">&quot;com&quot;</span>;<span class="st">&quot;co.uk&quot;</span>; <span class="st">&quot;de&quot;</span>;<span class="st">&quot;org&quot;</span>;<span class="st">&quot;net&quot;</span>;<span class="st">&quot;eu&quot;</span>;<span class="st">&quot;info&quot;</span>;<span class="st">&quot;online&quot;</span>;
            <span class="st">&quot;co&quot;</span>; <span class="st">&quot;cc&quot;</span>; <span class="st">&quot;website&quot;</span>|]

<span class="kw">let</span> tlds_count = Array<span class="kw">.</span>length tlds
<span class="kw">let</span> nr_domains = <span class="dv">24</span> * <span class="dv">3</span>
<span class="kw">let</span> digit_mapping = <span class="st">&quot;abcdnfolmk&quot;</span>

<span class="kw">let</span> seed_string ~date i =
  Printf<span class="kw">.</span>sprintf <span class="st">&quot;%d-%d-%d|%d&quot;</span>
    (D<span class="kw">.</span>day_of_month date)
    (D<span class="kw">.</span>month date |&gt; D<span class="kw">.</span>int_of_month)
    (D<span class="kw">.</span>year date)
    i

<span class="kw">let</span> domain_generate date =
  <span class="kw">let</span> <span class="kw">rec</span> helper count accum =
    <span class="kw">if</span> count = nr_domains <span class="kw">then</span> accum
    <span class="kw">else</span> seed_string ~date count :: helper (count + <span class="dv">1</span>) accum
  <span class="kw">in</span>
  helper <span class="dv">0</span> []

<span class="kw">let</span> () =
  Nocrypto_entropy_unix<span class="kw">.</span>initialize ();
  CalendarLib<span class="kw">.</span>Date<span class="kw">.</span>today ()
  |&gt; domain_generate
  |&gt; List<span class="kw">.</span>iter <span class="kw">begin</span> <span class="kw">fun</span> date_stamp -&gt;
    <span class="kw">let</span> hashed =
      (Cstruct<span class="kw">.</span>of_string date_stamp)
      |&gt; Nocrypto<span class="kw">.</span>Hash<span class="kw">.</span>digest <span class="dt">`SHA256</span>
      |&gt; Hex<span class="kw">.</span>of_cstruct |&gt; <span class="kw">function</span> <span class="dt">`Hex</span> s -&gt; s
    <span class="kw">in</span>
    <span class="kw">let</span> domain =
      String<span class="kw">.</span>sub hashed <span class="dv">3</span> <span class="dv">16</span>
      |&gt; Stringext<span class="kw">.</span>to_list
      |&gt; List<span class="kw">.</span>map
        (<span class="kw">function</span> <span class="ch">&#39;0&#39;</span>..<span class="ch">&#39;9&#39;</span> <span class="kw">as</span> hh -&gt;
          Char<span class="kw">.</span>code hh - <span class="dv">48</span> |&gt; String<span class="kw">.</span>get digit_mapping
                | o -&gt; o)
      |&gt; Stringext<span class="kw">.</span>of_list
    <span class="kw">in</span>
    <span class="kw">let</span> tld_index =
      String<span class="kw">.</span>get hashed (String<span class="kw">.</span>length hashed - <span class="dv">1</span>)
      |&gt; Printf<span class="kw">.</span>sprintf <span class="st">&quot;0x%c&quot;</span>
      |&gt; int_of_string
      |&gt; <span class="kw">fun</span> tld -&gt; <span class="kw">if</span> tld &gt;= tlds_count <span class="kw">then</span> <span class="dv">0</span> <span class="kw">else</span> tld
    <span class="kw">in</span>
    Printf<span class="kw">.</span>sprintf <span class="st">&quot;%s.%s&quot;</span> domain (Array<span class="kw">.</span>get tlds tld_index)
    |&gt; print_endline
  <span class="kw">end</span></code></pre></div>
<p>You can build it with a simple <code>Makefile</code> like this:</p>
<div class="sourceCode"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span class="dv">all:</span>
	ocamlfind ocamlopt main.ml <span class="ch">\</span>
	<span class="ch">-</span><span class="fu">package nocrypto.unix,calendar,hex,stringext </span><span class="ch">\</span>
<span class="fu">	-linkpkg -o Dga</span></code></pre></div>
<p>and here’s a sample output:</p>
<pre class="text"><code>&gt; ./Dga 
...
abbdddmfllkbamco.com
fbfknncbfcbbmlde.website
flcfcbaocdmbfbmb.website
mkaakfkaoocealda.com
doabakblkbaffmnd.cc
llacffaobdcodbca.com
fcdebfefakffamco.co
dbbbenbaalcbkbnl.com
dkomadcbodnamfbb.com
aanamlbblmaefofc.org</code></pre>
<p>For reference the github repo is <a href="https://github.com/fxfactorial/dga-padcrypt-ocaml">here</a>.</p>]]></description>
    <pubDate>Mon, 07 Mar 2016 00:00:00 UT</pubDate>
    <guid>http://hyegar.com/2016/03/07/dga-padcrypt-ocaml/index.html</guid>
    <dc:creator>Edgar Aroutiounian</dc:creator>
</item>
<item>
    <title>Date formating + hash digest example in OCaml</title>
    <link>http://hyegar.com/2016/03/06/get-date-string-in-ocaml/index.html</link>
    <description><![CDATA[<p>This is another blog post in my quest to improve the state of OCaml coding for the average programmer. Today’s blog post is getting a date string in OCaml, a seemingly trivial thing to do in many other programming languages, and using it in a real world hashing example.</p>
<h1 id="low-level-way">Low level way</h1>
<p>You do could it like this:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="co">(* Assume this is code.ml *)</span>
<span class="kw">let</span> time_now () =
  Unix<span class="kw">.</span>(
    <span class="kw">let</span> localtime = localtime (time ()) <span class="kw">in</span>
    Printf<span class="kw">.</span>sprintf <span class="st">&quot;[%02u:%02u:%02u]&quot;</span>
      localtime.tm_hour localtime.tm_min localtime.tm_sec)
	  
<span class="kw">let</span> () = time_now () |&gt; print_endline</code></pre></div>
<p>This will require you to link the <code>unix</code> package against your program, for example:</p>
<pre class="shell"><code>$ ocamlfind ocamlopt -package unix -linkpkg code.ml -o Time_now</code></pre>
<h1 id="higher-level-way-crypto-example">Higher level way + Crypto example</h1>
<p>At some point this low level interface might not be appropriate and you’ll want higher abstracts. <code>Calendar</code> is an package on opam that provides such abstractions; install with:</p>
<pre class="shell"><code>$ opam install calendar</code></pre>
<p>The API of <code>calendar</code>, which you’ll find under the module <code>CalendarLib</code>, is rather large. Here’s some real world code that you can reuse, built upon. The example also uses a cryptographic package which you can get with</p>
<pre class="shell"><code>$ opam install nocrypto</code></pre>
<p>and the code:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="co">(* Assume this is code.ml *)</span>
<span class="ot">module</span> D = CalendarLib<span class="kw">.</span><span class="dt">Date</span>

<span class="kw">let</span> nr_domains = <span class="dv">24</span>

<span class="kw">let</span> seed_string ~date i =
  Printf<span class="kw">.</span>sprintf
    <span class="st">&quot;%d-%d-%d:%d&quot;</span>
    (D<span class="kw">.</span>day_of_month date)
    (D<span class="kw">.</span>month date |&gt; D<span class="kw">.</span>int_of_month)
    (D<span class="kw">.</span>year date)
    i

<span class="kw">let</span> domain_generate date =
  <span class="kw">let</span> <span class="kw">rec</span> helper count accum =
    <span class="kw">if</span> count = nr_domains <span class="kw">then</span> accum
    <span class="kw">else</span> seed_string ~date count :: helper (count + <span class="dv">1</span>) accum
  <span class="kw">in</span>
  helper <span class="dv">0</span> []

<span class="kw">let</span> () =
  Nocrypto_entropy_unix<span class="kw">.</span>initialize ();
  CalendarLib<span class="kw">.</span>Date<span class="kw">.</span>today ()
  |&gt; domain_generate
  |&gt; List<span class="kw">.</span>iter <span class="kw">begin</span> <span class="kw">fun</span> date_stamp -&gt;
    Nocrypto<span class="kw">.</span>Hash<span class="kw">.</span>digest <span class="dt">`SHA256</span> (Cstruct<span class="kw">.</span>of_string date_stamp)
    |&gt; Cstruct<span class="kw">.</span>to_string |&gt; print_endline
  <span class="kw">end</span></code></pre></div>
<p>and compiling with:</p>
<pre class="shell"><code>$ ocamlfind ocamlopt -package calendar,nocrypto.unix -linkpkg code.ml -o Ex</code></pre>
<p>Yay. Be sure to check my archives for many more quick and useful posts on OCaml.</p>]]></description>
    <pubDate>Sun, 06 Mar 2016 00:00:00 UT</pubDate>
    <guid>http://hyegar.com/2016/03/06/get-date-string-in-ocaml/index.html</guid>
    <dc:creator>Edgar Aroutiounian</dc:creator>
</item>
<item>
    <title>Getting objective-c code completion on emacs</title>
    <link>http://hyegar.com/2016/03/02/emacs-for-objc/index.html</link>
    <description><![CDATA[<p>To get full code completion for objective-c in emacs you need to:</p>
<ol style="list-style-type: decimal">
<li>Have <code>company-mode</code> installed, its a generic backend for code completion in emacs and the community loves it.</li>
<li>Add some elisp to your <code>init.el</code>.</li>
</ol>
<p>I assume you have <code>company-mode</code> already installed, this will provide <code>company-clang</code> as well which is what will provide completion.</p>
<h1 id="some-elisp">Some elisp</h1>
<p>Here is my elisp that I use, you’ll notice that I also get codecompletion on Linux for objective-c, you can too by following my other blog <a href="http://hyegar.com/2016/02/22/ios-cross-compiler/">post</a>.</p>
<pre class="common-lisp"><code>(defvar osx-base-path
  &quot;/Applications/Xcode.app/Contents/Developer/Platforms/&quot;)

(if (equal system-type &#39;darwin)
    ; Only the then clause needs a progn, else part doesn&#39;t need it.
    (progn
      ;; Forgot what this was for..think some os x issues. 
      (setenv &quot;LC_CTYPE&quot; &quot;UTF-8&quot;)
      (setq mac-option-modifier &#39;super
	    flycheck-make-executable &quot;/usr/local/bin/make&quot;
	    company-clang-executable
	    (concat &quot;/Applications/Xcode.app/Contents/Developer/&quot;
		    &quot;Toolchains/XcodeDefault.xctoolchain/usr/bin/clang++&quot;)
	    company-clang-arguments
	    `(&quot;-std=c++11&quot;
	      &quot;-isysroot&quot;
	      ; If coding for iOS
	      ;; (concat osx-base-path
	      ;; &quot;iPhoneOS.platform/Developer/SDKs/iPhoneOS9.2.sdk&quot;)
	      ; If coding for OS X
	      ,(concat osx-base-path
		       &quot;MacOSX.platform/Developer/SDKs/MacOSX10.11.sdk&quot;)
	      &quot;-I&quot; &quot;/usr/include/c++/4.2.1&quot;
	      &quot;-I&quot; &quot;/usr/local/lib/ocaml/&quot;)
	    flycheck-c/c++-clang-executable
	    (concat &quot;/Applications/Xcode.app/Contents/Developer/&quot;
		    &quot;Toolchains/XcodeDefault.xctoolchain/usr/bin/clang++&quot;)
	    mac-command-modifier &#39;meta))
  (set-face-attribute &#39;default nil :height 110)
  (setq company-clang-executable &quot;armv7-apple-darwin11-clang&quot;
	company-clang-arguments &#39;(&quot;-std=c++11&quot;
				  &quot;-isysroot&quot;
				  &quot;/home/gar/.nix-profile/iPhoneOS9.2.sdk&quot;
				  &quot;-I/usr/local/lib/ocaml/&quot;)))

(setq company-backends &#39;(company-clang
			 company-capf
			 company-c-headers
			 company-jedi))
(add-to-list &#39;auto-mode-alist &#39;(&quot;\\.mm\\&#39;&quot; . objc-mode))
(global-set-key (kbd &quot;M-/&quot;) &#39;company-complete)</code></pre>
<p>Some of that is alittle opinionated and but the <code>company-clang-arguments</code> is the most important part really. Update the SDKs file name ending as this post becomes outdated.</p>
<p>Here’s what you should expect to see:</p>
<p><img src="/images/company-objc.png" />)</p>]]></description>
    <pubDate>Wed, 02 Mar 2016 00:00:00 UT</pubDate>
    <guid>http://hyegar.com/2016/03/02/emacs-for-objc/index.html</guid>
    <dc:creator>Edgar Aroutiounian</dc:creator>
</item>
<item>
    <title>Let's make a webkit browser in Objective-C++</title>
    <link>http://hyegar.com/2016/02/26/lets-make-a-browser/index.html</link>
    <description><![CDATA[<p>This is a short post showing you how to write a simple <code>OS X</code> based web browser using <code>Objective-C</code> in just 80 lines of code and with no XCode. Its very valuable because making a Cocoa application without XCode is sometimes kind of hard.</p>
<p>First let’s start with the <code>Makefile</code></p>
<div class="sourceCode"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span class="dt">opts </span><span class="ch">:=</span><span class="st"> -std=c++11 -fobjc-arc</span>
<span class="dt">fws </span><span class="ch">:=</span><span class="st"> -framework Cocoa -framework Webkit</span>
<span class="dt">libs </span><span class="ch">:=</span><span class="st"> -lc++</span>
<span class="dt">exec </span><span class="ch">:=</span><span class="st"> Prog</span>
<span class="dt">wrapper </span><span class="ch">:=</span><span class="st"> xcrun -r</span>

<span class="dv">all:</span>
	<span class="ch">${</span><span class="dt">wrapper</span><span class="ch">}</span> clang++ <span class="ch">${</span><span class="dt">opts</span><span class="ch">}</span> <span class="ch">${</span><span class="dt">fws</span><span class="ch">}</span> <span class="ch">${</span><span class="dt">libs</span><span class="ch">}</span> main.mm -o <span class="ch">${</span><span class="dt">exec</span><span class="ch">}</span>
	./<span class="ch">${</span><span class="dt">exec</span><span class="ch">}</span></code></pre></div>
<p>We’re going to use Webkit, ARC, C++11 and immediately run the program.</p>
<p>Now the program, I’m going to assume you are familiar with Cocoa development, Objective-C.</p>
<div class="sourceCode"><pre class="sourceCode objectivec"><code class="sourceCode objectivec"><span class="co">/* -*- objc -*- */</span>

<span class="ot">#import &lt;Foundation/Foundation.h&gt;</span>
<span class="ot">#import &lt;Webkit/WebKit.h&gt;</span>
<span class="ot">#import &lt;iostream&gt;</span>

<span class="kw">@interface</span> Window_delegate : NSObject &lt;NSWindowDelegate&gt;
<span class="kw">@end</span>

<span class="kw">@implementation</span> Window_delegate

-(<span class="dt">void</span>)windowWillClose:(id)a
{
  NSLog(<span class="st">@&quot;Exiting&quot;</span>);
  exit(<span class="dv">0</span>);
}
<span class="kw">@end</span>

<span class="kw">@interface</span> App_delegate : NSObject &lt;NSApplicationDelegate&gt;
@property (weak, nonatomic) NSWindow *_window;
<span class="kw">@end</span>

<span class="kw">@implementation</span> App_delegate

-(instancetype)init:(NSWindow*)parent_window
{
  <span class="kw">if</span> (<span class="kw">self</span> = [<span class="kw">super</span> init]) {
    <span class="kw">self</span>._window = parent_window;
    <span class="kw">return</span> <span class="kw">self</span>;
  }
  <span class="kw">return</span> nil;
}

-(<span class="dt">void</span>)applicationDidFinishLaunching:(NSNotification *)a_notification
{
  WebView *wb = [[WebView alloc] initWithFrame:<span class="kw">self</span>._window.contentView.frame];
  [<span class="kw">self</span>._window.contentView addSubview:wb];
  [[wb mainFrame]
    loadRequest:[NSURLRequest
		  requestWithURL:[NSURL URLWithString:<span class="st">@&quot;http://hyegar.com&quot;</span>]]];
}

<span class="kw">@end</span>

<span class="dt">void</span> start_program(<span class="dt">void</span>)
{
  NSApplication *app = [NSApplication sharedApplication];
  <span class="co">// Critical to have this so that you can add menus</span>
  [NSApp setActivationPolicy:NSApplicationActivationPolicyRegular];

  NSWindow *window =
    [[NSWindow alloc]
      initWithContentRect:NSMakeRect(<span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">800</span>, <span class="dv">600</span>)
		styleMask: NSTitledWindowMask | NSClosableWindowMask | NSMiniaturizableWindowMask
		  backing:NSBackingStoreBuffered
		    defer:NO];

  [window center];
  window.title = <span class="st">@&quot;Hello World&quot;</span>;
  [window makeKeyAndOrderFront:window];

  Window_delegate *d = [Window_delegate new];
  window.delegate = d;

  App_delegate *application_delegate = [[App_delegate alloc] init:window];
  app.delegate = application_delegate;
  [app activateIgnoringOtherApps:YES];
  [app run];
}

<span class="dt">int</span> main(<span class="dt">int</span> argc, <span class="dt">char</span> **argv)
{
  std::cout &lt;&lt; <span class="st">&quot;Starting Application</span><span class="ch">\n</span><span class="st">&quot;</span>;
  @autoreleasepool {
    start_program();
  }
}</code></pre></div>
<p>a simple <code>make</code> invocation at the command line will build and run this program which should open up a page to this blog.</p>
<p>Notice that <code>C++</code> wasn’t really used, I added it here to make this blog post content rich and code sample very reusable for you as a starter post.</p>
<p>A post in the future will show you how to add <code>NSMenu</code>(s) to this application.</p>]]></description>
    <pubDate>Fri, 26 Feb 2016 00:00:00 UT</pubDate>
    <guid>http://hyegar.com/2016/02/26/lets-make-a-browser/index.html</guid>
    <dc:creator>Edgar Aroutiounian</dc:creator>
</item>
<item>
    <title>Let's hack on Facebook flow</title>
    <link>http://hyegar.com/2016/02/25/lets-hack-on-flow/index.html</link>
    <description><![CDATA[<p>I’m writing this post for the JavaScript developer that wants to hack on flow but doesn’t know OCaml and is eager enough to learn some OCaml in pursuit of their hacking goals.</p>
<h1 id="getting-started.">Getting started.</h1>
<p>You’ll need to have <code>opam</code> installed, it is OCaml’s package manager. On <code>OS X</code> you can get it with <code>brew install opam</code>, on <code>debian</code> just use apt-get’s version and if on <code>Ubuntu</code> use this <a href="https://launchpad.net/~avsm/+archive/ubuntu/ppa">ppa</a></p>
<p>The very act of installing <code>opam</code> should have also installed a compiler, which we’ll need for building <code>flow</code>.</p>
<p>For completeness’s sake, we’ll do:</p>
<pre class="shell"><code>$ opam install ocamlfind ocamlbuild</code></pre>
<p>This should provide us with all the tools we need to build flow.</p>
<h1 id="building-flow-and-setting-goals">Building Flow and setting goals</h1>
<p>Now let’s build flow</p>
<pre class="shell"><code>$ git clone https://github.com/facebook/flow
$ cd flow
$ make</code></pre>
<p>and a sanity check:</p>
<pre class="shell"><code>$ bin/flow examples/01_HelloWorld
The flow server&#39;s version didn&#39;t match the client&#39;s, so it exited.
Going to launch a new one.

Launching Flow server for /Users/Edgar/Repos/flow/examples/01_HelloWorld
Spawned flow server (child pid=37837)
Logs will go to /private/tmp/flow/zSUserszSEdgarzSReposzSflowzSexampleszS01_HelloWorld.log
examples/01_HelloWorld/hello.js:7
  7: foo(&quot;Hello, world!&quot;);
     ^^^^^^^^^^^^^^^^^^^^ function call
  4:   return x*10;
              ^ string. This type is incompatible with
  4:   return x*10;
              ^^^^ number


Found 1 error</code></pre>
<p>this is expected of course. Let’s say our goal is to add some extra behavior around string <code>This type is incompatible</code>. First we try to find it.</p>
<pre class="shell"><code>$ cd src
$ grep -nIr &quot;This type is incompatible&quot; .</code></pre>
<p>Of the many hits we get we see that only two end in <code>.ml</code> which is the file extension for <code>OCaml</code> source code.</p>
<pre><code>./typing/flow_js.ml:3586:      let msg = &quot;This type is incompatible with&quot; in
./typing/flow_js.ml:3772:    &quot;This type is incompatible with&quot;</code></pre>
<p>Let’s open the second one on line <code>3772</code>, we see this function</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">and</span> err_msg l u =
  <span class="kw">if</span> is_use u
  <span class="kw">then</span> spf <span class="st">&quot;%s%s&quot;</span> (err_operation u) (err_value l)
  <span class="kw">else</span> <span class="st">&quot;This type is incompatible with&quot;</span></code></pre></div>
<p>it looks a little bit weird because it starts with an <code>and</code>. That’s okay, the <code>and</code> means that its being used in a function before its defined, otherwise it would have been:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> err_msg l u =
  <span class="kw">if</span> is_use u
  <span class="kw">then</span> spf <span class="st">&quot;%s%s&quot;</span> (err_operation u) (err_value l)
  <span class="kw">else</span> <span class="st">&quot;This type is incompatible with&quot;</span></code></pre></div>
<p>The function is named <code>err_msg</code>, it takes <code>l</code> and <code>u</code> and produces a <code>string</code>.</p>
<p>Let’s add a prefix to the string, we’ll change it to:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">and</span> err_msg l u =
  <span class="kw">if</span> is_use u
  <span class="kw">then</span> spf <span class="st">&quot;%s%s&quot;</span> (err_operation u) (err_value l)
  <span class="kw">else</span> <span class="st">&quot;Hello JS World-&gt; This type is incompatible with&quot;</span></code></pre></div>
<p>for completeness sake I assume you’re still in the <code>src</code> directory.</p>
<pre class="shell"><code>$ cd ..
$ make clean
$ make
$ bin/flow examples/01_HelloWorld 
The flow server&#39;s version didn&#39;t match the client&#39;s, so it exited.
Going to launch a new one.

Launching Flow server for /Users/Edgar/Repos/flow/examples/01_HelloWorld
Spawned flow server (child pid=40942)
Logs will go to /private/tmp/flow/zSUserszSEdgarzSReposzSflowzSexampleszS01_HelloWorld.log
examples/01_HelloWorld/hello.js:7
  7: foo(&quot;Hello, world!&quot;);
     ^^^^^^^^^^^^^^^^^^^^ function call
  4:   return x*10;
              ^ string. Hello JS World -&gt; This type is incompatible with
  4:   return x*10;
              ^^^^ number


Found 1 error</code></pre>
<p>Yay, we found the spot and changed it.</p>
<h1 id="now-lets-iterate-on-our-success">Now let’s iterate on our success</h1>
<p>Great, we changed the string, but let’s say we want to have some other stuff happen, let’s try some printing to the screen. We change <code>err_msg</code> to this instead:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">and</span> err_msg l u =
  <span class="kw">if</span> is_use u
  <span class="kw">then</span> spf <span class="st">&quot;%s%s&quot;</span> (err_operation u) (err_value l)
  <span class="kw">else</span> <span class="kw">begin</span>
    print_endline <span class="st">&quot;Hey Coder Reading hyegar.com&quot;</span>;
    <span class="st">&quot;Hello JS World -&gt; This type is incompatible with&quot;</span>
  <span class="kw">end</span></code></pre></div>
<h2 id="interesting-sidenotes">Interesting Sidenotes</h2>
<p>The <code>begin</code>, <code>end</code> are just syntax. I could have also written it using <code>( )</code> like so:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">and</span> err_msg l u =
  <span class="kw">if</span> is_use u
  <span class="kw">then</span> spf <span class="st">&quot;%s%s&quot;</span> (err_operation u) (err_value l)
  <span class="kw">else</span> (
    print_endline <span class="st">&quot;Hey Coder Reading hyegar.com&quot;</span>;
    <span class="st">&quot;Hello JS World -&gt; This type is incompatible with&quot;</span>)</code></pre></div>
<p>More interesting is the usage of <code>;</code>. First think to yourself, what is the return value of printing to the screen, nothing really. In OCaml we represent side effect and dummy values with <code>()</code>, said outloud as unit and written in type signatures as <code>unit</code>. When you see <code>unit</code> in a signature then it usually means the function is doing some kind of side effect like printing to screen or talking to a db.</p>
<p>So I could have also written it as:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">and</span> err_msg l u =
  <span class="kw">if</span> is_use u
  <span class="kw">then</span> spf <span class="st">&quot;%s%s&quot;</span> (err_operation u) (err_value l)
  <span class="kw">else</span> (
    <span class="kw">let</span> () = print_endline <span class="st">&quot;Hey Coder Reading hyegar.com&quot;</span> <span class="kw">in</span>
    <span class="st">&quot;Hello JS World -&gt; This type is incompatible with&quot;</span>)</code></pre></div>
<p>but the <code>;</code> is simplier and shorter.</p>
<p>Back to our coding:</p>
<p>…and now we do the same procedure as before including the <code>make clean</code> step. Now we run the code</p>
<pre class="shell"><code>$ bin/flow examples/01_HelloWorld
The flow server&#39;s version didn&#39;t match the client&#39;s, so it exited.
Going to launch a new one.

Launching Flow server for /Users/Edgar/Repos/flow/examples/01_HelloWorld
Spawned flow server (child pid=43811)
Logs will go to /private/tmp/flow/zSUserszSEdgarzSReposzSflowzSexampleszS01_HelloWorld.log
examples/01_HelloWorld/hello.js:7
  7: foo(&quot;Hello, world!&quot;);
     ^^^^^^^^^^^^^^^^^^^^ function call
  4:   return x*10;
              ^ string. Hello JS World -&gt; This type is incompatible with
  4:   return x*10;
              ^^^^ number


Found 1 error</code></pre>
<p>But where is our printed string of <code>Hey Coder Reading hyegar.com</code>?</p>
<h1 id="put-on-your-thinking-hat">Put on your thinking hat</h1>
<p>First clue is this: the error message is being created by the flow server. Many servers use logs and will redirect stdout, stderr to those logs, just makes sense to do that. Second clue is that <code>print_endline</code> prints to <code>stdout</code> and the third and final clue is that <code>flow</code> itself said at the beginning of invocation that:</p>
<pre><code>Logs will go to /private/tmp/flow/zSUserszSEdgarzSReposzSflowzSexampleszS01_HelloWorld.log</code></pre>
<p>and now we do a simple cat on this log file, yours will be named something unique to your machine, and see our calls to <code>print_endline</code> being made a surprisingly large number of times (Perhaps a question for the <code>flow</code> developers themselves)</p>
<pre class="shell"><code>cat /private/tmp/flow/zSUserszSEdgarzSReposzSflowzSexampleszS01_HelloWorld.log             ⏎
[2016-02-25 00:58:54] Initializing Server (This might take some time)
[2016-02-25 00:58:54] executable=/Users/Edgar/Repos/flow/bin/flow
[2016-02-25 00:58:54] version=0.22.0
[2016-02-25 00:58:54] Parsing
[2016-02-25 00:58:54] Building package heap
[2016-02-25 00:58:54] Running local inference
Hey Coder Reading hyegar.com
Hey Coder Reading hyegar.com
Hey Coder Reading hyegar.com
Hey Coder Reading hyegar.com
Hey Coder Reading hyegar.com
Hey Coder Reading hyegar.com
Hey Coder Reading hyegar.com
Hey Coder Reading hyegar.com
Hey Coder Reading hyegar.com
Hey Coder Reading hyegar.com
Hey Coder Reading hyegar.com
Hey Coder Reading hyegar.com
Hey Coder Reading hyegar.com
Hey Coder Reading hyegar.com
[2016-02-25 00:58:55] Re-resolving directly dependent files
[2016-02-25 00:58:55] Calculating dependencies
[2016-02-25 00:58:55] Merging
[2016-02-25 00:58:55] Done
[2016-02-25 00:58:55] Server is READY
[2016-02-25 00:58:55] Took 0.431947 seconds to initialize.
[2016-02-25 00:58:55] Status: Error</code></pre>
<p>And there you have it, now you start hacking on <code>OCaml</code> in flow. Be sure to check out my numerous other blog posts about <code>OCaml</code> including the jargon and build situation located <a href="http://hyegar.com/2015/10/20/so-youre-learning-ocaml/">here</a></p>]]></description>
    <pubDate>Thu, 25 Feb 2016 00:00:00 UT</pubDate>
    <guid>http://hyegar.com/2016/02/25/lets-hack-on-flow/index.html</guid>
    <dc:creator>Edgar Aroutiounian</dc:creator>
</item>
<item>
    <title>Use OCaml to create statically typed HTML</title>
    <link>http://hyegar.com/2016/02/24/tyxml-ocaml-example/index.html</link>
    <description><![CDATA[<h1 id="motivation">Motivation</h1>
<p>This blog post is part of my effort to make OCaml libraries, and therefore OCaml itself, more accessible and documented. We’ll focus on generating statically typed HTML using the <code>tyxml</code> package.</p>
<h1 id="simple-starter-code">Simple Starter code</h1>
<p>Let’s start by installing <code>tyxml</code> itself, we can do that with:</p>
<pre class="shell"><code>$ opam install tyxml</code></pre>
<p>And here’s the OCaml code:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="ot">open</span> Html5<span class="kw">.</span>M

<span class="kw">let</span> this_title = title (pcdata <span class="st">&quot;Your Cool Web Page&quot;</span>)

<span class="kw">let</span> image_box =
  div ~a:[a_id <span class="st">&quot;image_box&quot;</span>]
    []

<span class="kw">let</span> links_box =
  ul ~a:[a_class [<span class="st">&quot;links_bar&quot;</span>]; a_id <span class="st">&quot;links_bar&quot;</span>]
    [li ~a:[a_id <span class="st">&quot;home_click&quot;</span>]
       [pcdata <span class="st">&quot;My Musings&quot;</span>];
     li ~a:[a_id <span class="st">&quot;about_click&quot;</span>]
       [pcdata <span class="st">&quot;About Me&quot;</span>];
     li ~a:[a_id <span class="st">&quot;blog_posts_click&quot;</span>]
       [pcdata <span class="st">&quot;Blog&quot;</span>];
     li ~a:[a_id <span class="st">&quot;hackathons_click&quot;</span>]
       [pcdata <span class="st">&quot;Hackathons&quot;</span>]]

<span class="kw">let</span> common_footer =
  footer ~a:[a_id <span class="st">&quot;footer_box&quot;</span>]
    [p [pcdata <span class="st">&quot;This site was made with &quot;</span>;
        a ~a:[a_href <span class="st">&quot;http://ocaml.org&quot;</span>] [pcdata <span class="st">&quot;OCaml&quot;</span>];
        pcdata <span class="st">&quot; and &quot;</span>;
        a ~a:[a_href <span class="st">&quot;https://www.gnu.org/software/emacs/&quot;</span>] [pcdata <span class="st">&quot;emacs&quot;</span>]]]

<span class="kw">let</span> home_content =
  div
    [h2
       [pcdata <span class="st">&quot;Hello Coder&quot;</span>]]

<span class="kw">let</span> main_payload =
  div ~a:[a_id <span class="st">&quot;payload&quot;</span>]
    [home_content]

<span class="kw">let</span> common_nav =
  nav [links_box]

<span class="kw">let</span> content_box =
  div ~a:[a_id <span class="st">&quot;content_box&quot;</span>]
    [common_nav;
     main_payload;
     common_footer]

<span class="kw">let</span> main_script =
  script ~a:[a_src (Xml<span class="kw">.</span>uri_of_string <span class="st">&quot;main.js&quot;</span>)] (pcdata <span class="st">&quot;&quot;</span>)

<span class="kw">let</span> home_page_doc =
  html (head this_title
          [link ~rel:[<span class="dt">`Stylesheet</span>] ~href:<span class="st">&quot;home.css&quot;</span> ();])
    (body [image_box; content_box; main_script])

<span class="kw">let</span> pages = [(<span class="st">&quot;index.html&quot;</span>, home_page_doc)]

<span class="kw">let</span> () =
  List<span class="kw">.</span>iter <span class="kw">begin</span> <span class="kw">fun</span> (page_name, a_page) -&gt;
    Printf<span class="kw">.</span>sprintf <span class="st">&quot;Generating: %s&quot;</span> page_name |&gt; print_endline;
    <span class="kw">let</span> file_handle = open_out page_name <span class="kw">in</span>
    Html5<span class="kw">.</span>P<span class="kw">.</span>print (output_string file_handle) a_page;
    close_out file_handle;
    <span class="kw">match</span> Sys<span class="kw">.</span>command (Printf<span class="kw">.</span>sprintf <span class="st">&quot;tidy -im -ashtml %s&quot;</span> page_name) <span class="kw">with</span>
    | <span class="dv">0</span> -&gt; ()
    | c -&gt;
      print_endline <span class="st">&quot;You don&#39;t have tidy, no pretty printing of html&quot;</span>
  <span class="kw">end</span>
    pages</code></pre></div>
<p>Notice the example include a script tag usage and CSS usage. This is using just <code>tyxml</code> and the <code>stdlib</code>.</p>
<p>For completeness, here’s the CSS followed by the JavaScript and finally the Makefile to build it all</p>
<div class="sourceCode"><pre class="sourceCode css"><code class="sourceCode css"><span class="fl">#links_bar</span> li <span class="kw">{</span>
    <span class="kw">margin:</span><span class="dt">1em</span><span class="kw">;</span>
    <span class="kw">padding:</span><span class="dt">0.4em</span><span class="kw">;</span>
    <span class="kw">font-size:</span><span class="dt">large</span><span class="kw">;</span>
    <span class="kw">display:</span><span class="dt">inline</span><span class="kw">;</span>
    <span class="kw">cursor:</span><span class="dt">pointer</span><span class="kw">;</span>
    <span class="kw">border:</span><span class="dt">none</span><span class="kw">;</span>
    <span class="kw">border-radius:</span><span class="dt">0px</span><span class="kw">;</span>
    <span class="kw">transition:</span><span class="dt">.2s</span> linear<span class="kw">;</span>
    <span class="kw">text-align:</span><span class="dt">center</span><span class="kw">;</span>
<span class="kw">}</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="st">&quot;use strict&quot;</span><span class="op">;</span>

<span class="kw">var</span> handle <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;payload&quot;</span>)<span class="op">;</span>

<span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Hello World&quot;</span>)<span class="op">;</span>
<span class="va">console</span>.<span class="at">log</span>(handle)<span class="op">;</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span class="dt">site_gen </span><span class="ch">:=</span><span class="st"> make_site</span>

<span class="dv">all:</span>
	ocamlfind ocamlc site_html.ml -package tyxml -linkpkg -o <span class="ch">${</span><span class="dt">site_gen</span><span class="ch">}</span>
	./<span class="ch">${</span><span class="dt">site_gen</span><span class="ch">}</span>

<span class="dv">clean:</span>
	rm -f *.cmo *.cmt *.cmi <span class="ch">${</span><span class="dt">site_gen</span><span class="ch">}</span> index.html</code></pre></div>
<p>This all creates an <code>index.html</code> file that you can open in your browser. This example is also included in the <code>tyxml</code> source code under <code>examples</code>. I hope this helps you get started with OCaml easier.</p>]]></description>
    <pubDate>Wed, 24 Feb 2016 00:00:00 UT</pubDate>
    <guid>http://hyegar.com/2016/02/24/tyxml-ocaml-example/index.html</guid>
    <dc:creator>Edgar Aroutiounian</dc:creator>
</item>

    </channel>
</rss>
