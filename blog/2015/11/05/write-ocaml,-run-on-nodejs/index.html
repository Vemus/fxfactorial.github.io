<!DOCTYPE html>
<html lang="en-us">
<head>
  <title>Compile OCaml to JavaScript, run on Node - Edgar Aroutiounian</title>
  <meta charset="utf-8" />
  <meta name="author" content="Edgar Aroutiounian" />
  <meta name="description" content="OCaml on Node" />
  <meta name="keywords" content="nodejs, javascript, OCaml" />

  <link rel="alternate" title="RSS Feed" href="/rss.xml" type="application/rss+xml">

  <link rel="stylesheet" href="/media/css/main.css" type="text/css">
  <link rel="stylesheet" href="/media/css/prettify.css" type="text/css">
</head>

  <body class="container">
<header id="header">
  <h1 class="title"><a href="/">Edgar Aroutiounian</a></h1>
  <ul>
    <li><a href="/blog/">Blog</a></li>
    <li><a href="/tags/">Tags</a></li>
    <li><a href="/about/">About</a></li>
  </ul>
  <form method="get" id="search" action="https://duckduckgo.com">
    <input type="text" class="field" name="q" id="s" placeholder="Search">
    <input type="hidden" name="as_sitesearch" value="hyegar.com">
  </form>
</header>

<section id="content" role="main">
  <h1>Compile OCaml to JavaScript, run on Node</h1>
  <p>
I've been exposed to Node, its an amazing ecosystem with great cross
platform support and a great standard library; my only issue is
<b>JavaScript</b>. So I've been writing several libraries, bindings, that
compile OCaml to JavaScript which I then run on <code>node</code>.
</p>

<div id="outline-container-orgheadline1" class="outline-2">
<h2 id="orgheadline1">Sample Code</h2>
<div class="outline-text-2" id="text-orgheadline1">
<p>
Here are some working examples, many are directly from the README at
<a href="https://github.com/fxfactorial/ocaml-nodejs/blob/master/README.md">ocaml-nodejs</a>.
</p>

<p>
<b>Multicast DNS over UDP sockets, only for the local network, like a
 no config p2p chat application.</b>
</p>
<div class="org-src-container">

<pre class="src src-ocaml"><span class="linenr"> 1: </span>open Nodejs
<span class="linenr"> 2: </span>
<span class="linenr"> 3: </span>module U = Yojson.Basic.Util
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span>let (multicast_addr, bind_addr, port) = "224.1.1.1", "0.0.0.0", 6811
<span class="linenr"> 6: </span>
<span class="linenr"> 7: </span>let () =
<span class="linenr"> 8: </span>  Random.self_init ();
<span class="linenr"> 9: </span>  let p = new process in
<span class="linenr">10: </span>  let user_name = ref (Printf.sprintf "User:%d" (Random.int 10000)) in
<span class="linenr">11: </span>  let listener = Udp_datagram.(create_socket ~reuse_address:true Udp4) in
<span class="linenr">12: </span>  let sender = Udp_datagram.(create_socket ~reuse_address:true Udp4) in
<span class="linenr">13: </span>
<span class="linenr">14: </span>  listener#bind ~port ~address:multicast_addr ~f:begin fun () -&gt;
<span class="linenr">15: </span>    listener#add_membership multicast_addr;
<span class="linenr">16: </span>    listener#set_broadcast true;
<span class="linenr">17: </span>    listener#set_multicast_loopback true
<span class="linenr">18: </span>  end ();
<span class="linenr">19: </span>
<span class="linenr">20: </span>
<span class="linenr">21: </span>  listener#on_message begin fun b resp -&gt;
<span class="linenr">22: </span>
<span class="linenr">23: </span>    let handle = b#to_string () |&gt; json_of_string in
<span class="linenr">24: </span>    if (handle &lt;!&gt; "id" |&gt; Js.to_string) &lt;&gt; !user_name
<span class="linenr">25: </span>    then print_string (handle &lt;!&gt; "message" |&gt; Js.to_string)
<span class="linenr">26: </span>
<span class="linenr">27: </span>  end;
<span class="linenr">28: </span>
<span class="linenr">29: </span>  p#stdin#on_data begin function
<span class="linenr">30: </span>    | String _ -&gt; ()
<span class="linenr">31: </span>    | Buffer b -&gt;
<span class="linenr">32: </span>      let msg = b#to_string () in
<span class="linenr">33: </span>      (* This needs to be redone with Re_pcre *)
<span class="linenr">34: </span>      if String.length msg &gt; 10 then begin
<span class="linenr">35: </span>        let modify = String.sub msg 0 9 in
<span class="linenr">36: </span>        if modify = "set name:"
<span class="linenr">37: </span>        then begin
<span class="linenr">38: </span>          let as_string = Js.string (String.trim msg) in
<span class="linenr">39: </span>          let chopped =
<span class="linenr">40: </span>            as_string##split (Js.string ":") |&gt; to_string_list |&gt; Array.of_list
<span class="linenr">41: </span>          in
<span class="linenr">42: </span>          user_name := chopped.(1)
<span class="linenr">43: </span>        end
<span class="linenr">44: </span>      end;
<span class="linenr">45: </span>
<span class="linenr">46: </span>      let msg = Printf.sprintf "%s&gt;&gt;&gt;%s" !user_name (b#to_string ()) in
<span class="linenr">47: </span>      let total_message = (object%js
<span class="linenr">48: </span>        val id = !user_name |&gt; to_js_str
<span class="linenr">49: </span>        val message = msg |&gt; to_js_str
<span class="linenr">50: </span>        end) |&gt; stringify
<span class="linenr">51: </span>      in
<span class="linenr">52: </span>      sender#send
<span class="linenr">53: </span>        ~offset:0
<span class="linenr">54: </span>        ~length:(String.length total_message)
<span class="linenr">55: </span>        ~port
<span class="linenr">56: </span>        ~dest_address:multicast_addr
<span class="linenr">57: </span>        (String total_message)
<span class="linenr">58: </span>    end
</pre>
</div>

<p>
<b>Create a site and render directly from jade templates</b>
</p>
<div class="org-src-container">

<pre class="src src-ocaml">open Nodejs

let () =
  let exp = new Express.express in
  let app = new Express.app ~existing:None in

  app#set_app_value (`View_engine "jade");
  app#use (exp#static ".");
  app#get ~path:"/" (fun _ res -&gt; res#render "index.jade");

  app#listen ~port:8080
</pre>
</div>

<p>
<b>Create a raw server from the Net module</b>
</p>
<div class="org-src-container">

<pre class="src src-ocaml">let () =
  let server = Net.create_server ~conn_listener:begin fun sock -&gt;
      sock#on_end (fun () -&gt; print_endline "client disconnected");
      sock#write "Hello\r\n";
      sock &gt;|&gt; sock |&gt; ignore
    end ()
  in
  server#listen ~port:8124 begin fun () -&gt;
    let info = server#address in
    print_endline info.Net.address;
    print_endline (info.Net.ip_family |&gt; string_of_ip);
    print_endline (info.Net.port |&gt; string_of_int);
    print_endline "started server"
  end
</pre>
</div>

<p>
<b>Create a file stream, gzip it, write it</b>
</p>
<div class="org-src-container">

<pre class="src src-ocaml"><span class="linenr">1: </span>open Nodejs
<span class="linenr">2: </span>
<span class="linenr">3: </span>let _ =
<span class="linenr">4: </span>  Fs.create_read_stream "code.ml" &gt;|&gt;
<span class="linenr">5: </span>  Zlib.create_gzip () &gt;|&gt;
<span class="linenr">6: </span>  Fs.create_write_stream "NEWCODE_TEST.ml"
</pre>
</div>


<p>
<b>Typed Decoding of Buffers</b>
</p>
<div class="org-src-container">

<pre class="src src-ocaml">open Nodejs

let () =
  let string_decoder = new String_decoder.decoder Utf_8 in
  let cent = new Buffer.buffer (`Array [|0xE2; 0x82; 0xAC|]) in
  (string_decoder#write cent) |&gt; print_endline
</pre>
</div>


<p>
This one is a bit more low level as it its a general idea of how these
bindings are implemented.
</p>

<div class="org-src-container">

<pre class="src src-ocaml"><span class="linenr"> 1: </span>(* Assume this file is called c.ml *)
<span class="linenr"> 2: </span>open Nodejs
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>class child_process = object
<span class="linenr"> 5: </span>
<span class="linenr"> 6: </span>  val raw_js = require_module "child_process"
<span class="linenr"> 7: </span>
<span class="linenr"> 8: </span>  (* Clearly not finished *)
<span class="linenr"> 9: </span>  method spawn_sync cmd args : (string * string) list =
<span class="linenr">10: </span>    let handle =
<span class="linenr">11: </span>      [|i (Js.string cmd);
<span class="linenr">12: </span>        i (List.map Js.string args |&gt; Array.of_list |&gt; Js.array)|]
<span class="linenr">13: </span>      |&gt; m raw_js "spawnSync"
<span class="linenr">14: </span>    in
<span class="linenr">15: </span>    (handle &lt;!&gt; "envPairs")
<span class="linenr">16: </span>    |&gt; Js.to_array |&gt; Array.map begin fun (s : Js.js_string Js.t) -&gt;
<span class="linenr">17: </span>      let chop = s##split (Js.string "=") |&gt; to_string_list |&gt; Array.of_list in
<span class="linenr">18: </span>      (chop.(0), chop.(1))
<span class="linenr">19: </span>    end
<span class="linenr">20: </span>    |&gt; Array.to_list
<span class="linenr">21: </span>
<span class="linenr">22: </span>end
<span class="linenr">23: </span>
<span class="linenr">24: </span>let () =
<span class="linenr">25: </span>  let ls_proc = (new child_process)#spawn_sync "ls" [] in
<span class="linenr">26: </span>  ls_proc |&gt; List.iter begin fun (key, value) -&gt;
<span class="linenr">27: </span>    Printf.sprintf "Key was: %s and value: %s" key value
<span class="linenr">28: </span>    |&gt; print_endline
<span class="linenr">29: </span>  end
</pre>
</div>

<p>
(Line one comes from my <code>nodejs</code> package, install it with <code>opam install
nodejs</code>). 
</p>

<p>
This example is a subset of my bindings to the builtin node module,
<a href="https://nodejs.org/api/child_process.html">child_process</a>. Here we spawn a separate process and create an OCaml
<code>alist</code> out of the environment variables of the spawned process. A
point of interest is the poverty of OCaml StdLib's <code>String</code> module, so
much so that I get more functionality out of JavaScript's string
methods! (There's no split in the StdLib). 
</p>

<p>
To actually run this code you'll need to do:
</p>

<div class="org-src-container">

<pre class="src src-shell">$ ocamlfind ocamlc c.ml -linkpkg -package nodejs -o T.out
$ js_of_ocaml T.out
$ node T.js
</pre>
</div>
</div>
</div>

<div id="outline-container-orgheadline2" class="outline-2">
<h2 id="orgheadline2">Projects</h2>
<div class="outline-text-2" id="text-orgheadline2">
<p>
This approach surprisingly works and I've written similar bindings to
<a href="https://github.com/fxfactorial/ocaml-npm-socket-io">socket.io</a> for which I have a working chat server:
</p>

<div class="org-src-container">

<pre class="src src-ocaml">open Nodejs

let () =
  let io = Socket_io.require () in
  let server =
    Http.create_server begin fun incoming response -&gt;

      Fs.read_file ~path:"./client.html" begin fun err data -&gt;
        response#write_head ~status_code:200 [("Content-type", "text/html")];
        response#end_ ~data:(Http.String data) ()

      end
    end
  in
  let app = server#listen ~port:8080 begin fun () -&gt;
      Printf.sprintf
        "Started Server and Running node: %s" (new process#version)
      |&gt; print_endline
    end
  in

  let io = io#listen app in
  io#sockets#on_connection begin fun socket -&gt;

    socket#on "message_to_server" begin fun data -&gt;

      io#sockets#emit
        ~event_name:"message_to_client"
        !!(object%js val message = data &lt;!&gt; "message" end)

    end
  end
</pre>
</div>
<p>
Notice the features of OCaml that don't exist in JavaScript at all,
like named parameters.
</p>

<p>
Another project in this vein are my bindings to Github's <code>Electron</code>
project, here's a project I did with a friend using Basecamp's
recently released <code>Trix</code> editor.
</p>


<div class="figure">
<p><img src="./electron_working.gif" alt="electron_working.gif" />
</p>
</div>
</div>
</div>

<div id="outline-container-orgheadline3" class="outline-2">
<h2 id="orgheadline3">Like what you see?</h2>
<div class="outline-text-2" id="text-orgheadline3">
<p>
Writing out these bindings is a bit of work, Node's API is pretty big
in addition to third party code like socket.io, express, and
Electron. Much of these bindings are quite formulaic, although some
ideas don't easily match up between the OCaml and JavaScript boundary,
like <code>varargs</code> so that requires some more thought at times. 
</p>

<p>
To any reader interested in OCaml open-source or for whatever reason,
send me a PR, its mostly an issue of translating <a href="https://nodejs.org/api/index.html">the Node API</a> into the
equivalent bindings:
</p>

<p>
<a href="https://github.com/fxfactorial/ocaml-nodejs">nodejs repo</a>
</p>

<p>
<a href="https://github.com/fxfactorial/ocaml-electron">electron repo</a>
</p>
</div>
</div>

</section>



<footer id="footer">
    Send comments, critique and suggestions to <a href="mailto:edgar &lt;dot&gt; factorial &lt;at&gt; gmail &lt;dot&gt; com">Edgar Aroutiounian</a>.
    Powered by <a href="https://github.com/kelvinh/org-page">org-page</a>
</footer>

  </body>
</html>
