<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Personal blog of Edgar Aroutiounian">
    <meta name="author" content="Edgar Aroutiounian">
    <title>hyegar.com - Home</title>
    <link rel="canonical" href="http://hyegar.com">
    <link rel="icon" href="./favicon.png" type="image/png">
    <link rel="apple-touch-icon" sizes="60x60" href="./images/favicon-60.png" type="image/png">
    <link rel="apple-touch-icon" sizes="76x76" href="./images/favicon-76.png" type="image/png">
    <link rel="apple-touch-icon" sizes="120x120" href="./images/favicon-120.png" type="image/png">
    <link rel="apple-touch-icon" sizes="152x152" href="./images/favicon-152.png" type="image/png">
    <link rel="stylesheet" type="text/css" href="./css/main.css">
    <link href="./atom.xml" rel="alternate" title="hyegar.com - A personal and developer blog" type="application/atom+xml">
    <link type="text/plain" rel="author" href="./humans.txt">
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-57031124-1', 'auto');
      ga('send', 'pageview');
    </script>

  </head>

  <body>
    <header id="page_header">
    <h1><a href="./" title="Home">Edgar Aroutiounian</a></h1>
</header>

    <nav id="page_navigation">
    <ul>
        <li><a href="./">Home</a></li>
        <li><a href="./about">About</a></li>
        <li><a href="./archive">Archive</a></li>
        <li><a href="./notes">Notes</a></li>
        <li><a href="./talks">Talks</a></li>
    </ul>
</nav>

    
    <section id="content">
      <article>
    <header>
        <h1>
            <a href="./2016/02/24/tyxml-ocaml-example/" title="Permalink">
                Use OCaml to create statically typed HTML
            </a>
        </h1>
        <span class="post-date">February 24, 2016</span> in 
        <span class="post-tags"><a href="./tags/ocaml/">ocaml</a>, <a href="./tags/tyxml/">tyxml</a>, <a href="./tags/html/">html</a>, <a href="./tags/web/">web</a>, <a href="./tags/example/">example</a></span>
    </header>
    <h1 id="motivation">Motivation</h1>
<p>This blog post is part of my effort to make OCaml libraries, and therefore OCaml itself, more accessible and documented. We’ll focus on generating statically typed HTML using the <code>tyxml</code> package.</p>
<h1 id="simple-starter-code">Simple Starter code</h1>
<p>Let’s start by installing <code>tyxml</code> itself, we can do that with:</p>
<pre class="shell"><code>$ opam install tyxml</code></pre>
<p>And here’s the OCaml code:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="ot">open</span> Html5<span class="kw">.</span>M

<span class="kw">let</span> this_title = title (pcdata <span class="st">&quot;Your Cool Web Page&quot;</span>)

<span class="kw">let</span> image_box =
  div ~a:[a_id <span class="st">&quot;image_box&quot;</span>]
    []

<span class="kw">let</span> links_box =
  ul ~a:[a_class [<span class="st">&quot;links_bar&quot;</span>]; a_id <span class="st">&quot;links_bar&quot;</span>]
    [li ~a:[a_id <span class="st">&quot;home_click&quot;</span>]
       [pcdata <span class="st">&quot;My Musings&quot;</span>];
     li ~a:[a_id <span class="st">&quot;about_click&quot;</span>]
       [pcdata <span class="st">&quot;About Me&quot;</span>];
     li ~a:[a_id <span class="st">&quot;blog_posts_click&quot;</span>]
       [pcdata <span class="st">&quot;Blog&quot;</span>];
     li ~a:[a_id <span class="st">&quot;hackathons_click&quot;</span>]
       [pcdata <span class="st">&quot;Hackathons&quot;</span>]]

<span class="kw">let</span> common_footer =
  footer ~a:[a_id <span class="st">&quot;footer_box&quot;</span>]
    [p [pcdata <span class="st">&quot;This site was made with &quot;</span>;
        a ~a:[a_href <span class="st">&quot;http://ocaml.org&quot;</span>] [pcdata <span class="st">&quot;OCaml&quot;</span>];
        pcdata <span class="st">&quot; and &quot;</span>;
        a ~a:[a_href <span class="st">&quot;https://www.gnu.org/software/emacs/&quot;</span>] [pcdata <span class="st">&quot;emacs&quot;</span>]]]

<span class="kw">let</span> home_content =
  div
    [h2
       [pcdata <span class="st">&quot;Hello Coder&quot;</span>]]

<span class="kw">let</span> main_payload =
  div ~a:[a_id <span class="st">&quot;payload&quot;</span>]
    [home_content]

<span class="kw">let</span> common_nav =
  nav [links_box]

<span class="kw">let</span> content_box =
  div ~a:[a_id <span class="st">&quot;content_box&quot;</span>]
    [common_nav;
     main_payload;
     common_footer]

<span class="kw">let</span> main_script =
  script ~a:[a_src (Xml<span class="kw">.</span>uri_of_string <span class="st">&quot;main.js&quot;</span>)] (pcdata <span class="st">&quot;&quot;</span>)

<span class="kw">let</span> home_page_doc =
  html (head this_title
          [link ~rel:[<span class="dt">`Stylesheet</span>] ~href:<span class="st">&quot;home.css&quot;</span> ();])
    (body [image_box; content_box; main_script])

<span class="kw">let</span> pages = [(<span class="st">&quot;index.html&quot;</span>, home_page_doc)]

<span class="kw">let</span> () =
  List<span class="kw">.</span>iter <span class="kw">begin</span> <span class="kw">fun</span> (page_name, a_page) -&gt;
    Printf<span class="kw">.</span>sprintf <span class="st">&quot;Generating: %s&quot;</span> page_name |&gt; print_endline;
    <span class="kw">let</span> file_handle = open_out page_name <span class="kw">in</span>
    Html5<span class="kw">.</span>P<span class="kw">.</span>print (output_string file_handle) a_page;
    close_out file_handle;
    <span class="kw">match</span> Sys<span class="kw">.</span>command (Printf<span class="kw">.</span>sprintf <span class="st">&quot;tidy -im -ashtml %s&quot;</span> page_name) <span class="kw">with</span>
    | <span class="dv">0</span> -&gt; ()
    | c -&gt;
      print_endline <span class="st">&quot;You don't have tidy, no pretty printing of html&quot;</span>
  <span class="kw">end</span>
    pages</code></pre></div>
<p>Notice the example include a script tag usage and CSS usage. This is using just <code>tyxml</code> and the <code>stdlib</code>.</p>
<p>For completeness, here’s the CSS followed by the JavaScript and finally the Makefile to build it all</p>
<div class="sourceCode"><pre class="sourceCode css"><code class="sourceCode css"><span class="fl">#links_bar</span> li <span class="kw">{</span>
    <span class="kw">margin:</span><span class="dt">1em</span><span class="kw">;</span>
    <span class="kw">padding:</span><span class="dt">0.4em</span><span class="kw">;</span>
    <span class="kw">font-size:</span><span class="dt">large</span><span class="kw">;</span>
    <span class="kw">display:</span><span class="dt">inline</span><span class="kw">;</span>
    <span class="kw">cursor:</span><span class="dt">pointer</span><span class="kw">;</span>
    <span class="kw">border:</span><span class="dt">none</span><span class="kw">;</span>
    <span class="kw">border-radius:</span><span class="dt">0px</span><span class="kw">;</span>
    <span class="kw">transition:</span><span class="dt">.2s</span> linear<span class="kw">;</span>
    <span class="kw">text-align:</span><span class="dt">center</span><span class="kw">;</span>
<span class="kw">}</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="st">&quot;use strict&quot;</span><span class="op">;</span>

<span class="kw">var</span> handle <span class="op">=</span> <span class="va">document</span>.<span class="at">getElementById</span>(<span class="st">&quot;payload&quot;</span>)<span class="op">;</span>

<span class="va">console</span>.<span class="at">log</span>(<span class="st">&quot;Hello World&quot;</span>)<span class="op">;</span>
<span class="va">console</span>.<span class="at">log</span>(handle)<span class="op">;</span></code></pre></div>
<div class="sourceCode"><pre class="sourceCode makefile"><code class="sourceCode makefile"><span class="dt">site_gen </span><span class="ch">:=</span><span class="st"> make_site</span>

<span class="dv">all:</span>
	ocamlfind ocamlc site_html.ml -package tyxml -linkpkg -o <span class="ch">${</span><span class="dt">site_gen</span><span class="ch">}</span>
	./<span class="ch">${</span><span class="dt">site_gen</span><span class="ch">}</span>

<span class="dv">clean:</span>
	rm -f *.cmo *.cmt *.cmi <span class="ch">${</span><span class="dt">site_gen</span><span class="ch">}</span> index.html</code></pre></div>
<p>This all creates an <code>index.html</code> file that you can open in your browser. This example is also included in the <code>tyxml</code> source code under <code>examples</code>. I hope this helps you get started with OCaml easier.</p>
</article>
<article>
    <header>
        <h1>
            <a href="./2016/02/22/ios-cross-compiler/" title="Permalink">
                Getting an iOS compiler on Linux, full Objective-C support
            </a>
        </h1>
        <span class="post-date">February 22, 2016</span> in 
        <span class="post-tags"><a href="./tags/ios/">ios</a>, <a href="./tags/linux/">linux</a>, <a href="./tags/cross%20compiler/">cross compiler</a>, <a href="./tags/nixos/">nixos</a>, <a href="./tags/nixpkgs/">nixpkgs</a>, <a href="./tags/objective-c/">objective-c</a></span>
    </header>
    <h1 id="the-problem">The problem</h1>
<p>Lately I’ve been doing iPhone low level debugging, forensics, and reverse engineering. For that I need an <code>iOS</code> compiler and that has usually only been available on <code>OS X</code>. However my day time development environment is Linux which clearly doesn’t have an <code>objective-c</code> runtime or libraries…how to solve this?</p>
<h1 id="the-solution">The solution</h1>
<p>I found this <a href="https://github.com/tpoechtrager/osxcross">project</a> but it was very hands on and difficult to reproduce on multiple machines. How could I reliably build this code? My solution was <code>NixOS</code>, specifically the <code>nixpkgs</code> package manager (I won’t go into the benefits of <code>Nix</code> in this post). Now you can also benefit from this work by getting an <code>armv7</code> iOS cross compiler for up to <code>iOS 9.2</code> by simply doing:</p>
<pre class="shell"><code>$ nix-env -i clang ios-cross-compile</code></pre>
<p>This will crap out initially because I cannot redistribute iOS SDKs, but it does give you instructions on how to manually add something to the <code>nix-store</code>. After you follow the instructions run the command again and then you’ll have all these tools</p>
<pre><code>armv7-apple-darwin11-ar                 armv7-apple-darwin11-nm
armv7-apple-darwin11-as                 armv7-apple-darwin11-nmedit
armv7-apple-darwin11-bitcode_strip      armv7-apple-darwin11-ObjectDump
armv7-apple-darwin11-checksyms          armv7-apple-darwin11-otool
armv7-apple-darwin11-clang              armv7-apple-darwin11-pagestuff
armv7-apple-darwin11-clang++            armv7-apple-darwin11-ranlib
armv7-apple-darwin11-codesign_allocate  armv7-apple-darwin11-redo_prebinding
armv7-apple-darwin11-dyldinfo           armv7-apple-darwin11-seg_addr_table
armv7-apple-darwin11-indr               armv7-apple-darwin11-segedit
armv7-apple-darwin11-install_name_tool  armv7-apple-darwin11-seg_hack
armv7-apple-darwin11-ld                 armv7-apple-darwin11-size
armv7-apple-darwin11-libtool            armv7-apple-darwin11-strings
armv7-apple-darwin11-lipo               armv7-apple-darwin11-strip
armv7-apple-darwin11-machocheck         armv7-apple-darwin11-unwinddump</code></pre>
<p>…installed and they will work for SDK <code>7.0-9.2</code>!</p>
<h1 id="stay-tuned">Stay tuned</h1>
<p>I’ll have more blog posts lined up including:</p>
<ol style="list-style-type: decimal">
<li><p>How to get correct code completion for objective-c on Linux in emacs</p></li>
<li><p>Creating iPhone command line tools, tweaks in C++, Objective-C using theos.</p></li>
</ol>
</article>
<article>
    <header>
        <h1>
            <a href="./2016/01/24/see-http-traffic-with-proxy/" title="Permalink">
                Proxy yourself
            </a>
        </h1>
        <span class="post-date">January 24, 2016</span> in 
        <span class="post-tags"><a href="./tags/infosec/">infosec</a>, <a href="./tags/proxy/">proxy</a>, <a href="./tags/mitmproxy/">mitmproxy</a></span>
    </header>
    <p>Often times we want to see our network traffic in an organized way, one tool we can use is <code>tcpdump</code> but its a pretty low level tool and often times HTTP is all we actually care about.</p>
<h1 id="mitmproxy-man-in-the-middle-proxy">mitmproxy (man in the middle proxy)</h1>
<p>I’ve been using <code>mitmproxy</code>, its an incredible Python tool that is designed for HTTP and I especially love the command line ncurses interface. Its designed for man in the middle attacks but you can also use it as a debugging tool. Its installable with <code>pip</code> but I just settle for the version that is present on the package manager. With <code>mitmproxy</code> we’ll see all the HTTP traffic in a clean and organized way; <code>mitmproxy</code> is MUCH nicer than using squid and the icky configurations that come along with squid.</p>
<h1 id="example">Example</h1>
<p>This example was tested and works on Ubuntu 14.04 and also worked on an Ubuntu 14.04 VM running on VMWare on OS X.</p>
<p>Essentially we will send all IP traffic from our local machine through <code>mitmproxy</code> as a proxy, this is apparently called a local transparent proxy.</p>
<p>First we set up some rules for the Linux kernel:</p>
<p>I’m going to assume you have another Unix account named mitm_account, yes two accounts are needed.</p>
<pre class="shell"><code>$ sudo iptables -t nat -A OUTPUT -p tcp \
  -m owner ! --uid-owner mitm_account \
  --dport 443 -j REDIRECT --to-port 9001</code></pre>
<p>This looks complicated, you can read up on the <code>iptables</code> man page for all the nitty gritty details. I will try to get a <code>OS X</code> equivalent as well. We also do this same command over, but change <code>--dport</code> to 80 for regular HTTP traffic as well.</p>
<p>Note the <code>mitm_account</code>. This is the name of some other account, you’ll need to have two Unix accounts for this to work and <code>mitm_account</code> is the Unix account we’ll use that will actually run the <code>mitmproxy</code> program.</p>
<p>Then we’ll open another shell and change users to mitm_account and run:</p>
<pre class="shell"><code>$ mitmproxy -T -p 9001</code></pre>
<p>And this will start the proxy interceptions.</p>
</article>
<article>
    <header>
        <h1>
            <a href="./2016/01/23/calling-ocaml-from-objective-c/" title="Permalink">
                Calling OCaml from Objective-C
            </a>
        </h1>
        <span class="post-date">January 23, 2016</span> in 
        <span class="post-tags"><a href="./tags/OCaml/">OCaml</a>, <a href="./tags/objective-c/">objective-c</a>, <a href="./tags/cross%20compiler/">cross compiler</a></span>
    </header>
    <p>I love iOS and I love OCaml, so I’ve packaged up an OCaml compiler for iOS via opam. Now all you need to build OCaml programs on the iPhone is opam!</p>
<h1 id="first-steps">First steps</h1>
<p>You’ll need the cross compiler. Follow the README instructions mentioned <a href="https://github.com/fxfactorial/opam-ios">here</a>. This will provide you with the cross compiler based on OCaml 4.02.0.</p>
<h1 id="example-code">Example Code</h1>
<p>Now I’ll show you an example of calling OCaml from Objective-C. Much of this code will have simplifications as its an example for getting you started. Also note that dealing at the C level and the OCaml runtime can be tricky and is not for beginners.</p>
<p>Here’s the OCaml code first, assume it is named code.ml</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="dv">1</span>  <span class="kw">let</span> make_string () =
<span class="dv">2</span>    print_endline <span class="st">&quot;Hello Word from OCaml&quot;</span>;
<span class="dv">3</span>    <span class="st">&quot;Hello World &quot;</span>
<span class="dv">4</span>  
<span class="dv">5</span>  <span class="kw">let</span> () =
<span class="dv">6</span>    Callback<span class="kw">.</span>register <span class="st">&quot;make_string&quot;</span> make_string</code></pre></div>
<p>We’re essentially telling the runtime to make this function available to grab as a handle, in this case it’s a handle on a closure.</p>
<p>And now the Objective-C code, assume it is named main.c</p>
<div class="sourceCode"><pre class="sourceCode objectivec"><code class="sourceCode objectivec"> <span class="dv">1</span>  #define CAML_NAME_SPACE
 <span class="dv">2</span>  
 <span class="dv">3</span>  #import &lt;Foundation/Foundation.h&gt;
 <span class="dv">4</span>  
 <span class="dv">5</span>  #include &lt;caml/callback.h&gt;
 <span class="dv">6</span>  #include &lt;caml/mlvalues.h&gt;
 <span class="dv">7</span>  
 <span class="dv">8</span>  <span class="dt">int</span> main (<span class="dt">int</span> argc, <span class="dt">char</span> **argv)
 <span class="dv">9</span>  {
<span class="dv">10</span>    caml_startup(argv);
<span class="dv">11</span>    caml_callback(*caml_named_value(<span class="st">&quot;make_string&quot;</span>), Val_unit);
<span class="dv">12</span>    NSLog(<span class="st">@&quot;Now using objective-c code&quot;</span>);
<span class="dv">13</span>    <span class="kw">return</span> <span class="dv">0</span>;
<span class="dv">14</span>  }</code></pre></div>
<p>Its important to call <code>caml_startup</code> before any OCaml callbacks. Then we get a handle on the closure and call it with unit.</p>
<p>To compile this code you’ll need the cross-compiler which was installed by following the directions on my opam-ios repo, the command you use is:</p>
<pre class="shell"><code>$ ocamloptrev -rev 8.3 -ccopt -ObjC -cclib '-framework Foundation' main.c code.ml -o F</code></pre>
<p>The 8.3 is the iOS SDK you want to link against, again see the README on the github repo for opam-ios for more details.</p>
<p>The output we get, <code>F</code> is an arm executable, when we run it on the iPhone we will get an output of:</p>
<pre class="shell"><code>$ some_iphone :~/  ./F
Hello Word from OCaml
2016-01-23 22:44:04.889 F[1977:507] Now using objective-c code</code></pre>
<p>Yay!</p>
</article>
<article>
    <header>
        <h1>
            <a href="./2015/12/03/write_ocaml_on_node/" title="Permalink">
                Write OCaml, run on node
            </a>
        </h1>
        <span class="post-date">December  3, 2015</span> in 
        <span class="post-tags"><a href="./tags/OCaml/">OCaml</a>, <a href="./tags/nodejs/">nodejs</a>, <a href="./tags/javascript/">javascript</a>, <a href="./tags/js_of_ocaml/">js_of_ocaml</a></span>
    </header>
    <p>I’ve been exposed to Node, its an amazing ecosystem with great cross platform support and a great standard library; my only issue is <strong>JavaScript</strong>. So I’ve been writing several libraries, bindings, that compile OCaml to JavaScript which I then run on <code>node</code>.</p>
<h1 id="sample-code">Sample Code</h1>
<p>Here are some working examples, many are directly from the README at <a href="https://github.com/fxfactorial/ocaml-nodejs/blob/master/README.md">ocaml-nodejs</a>.</p>
<p><strong>Multicast DNS over UDP sockets, only for the local network, like a no config p2p chat application.</strong></p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"> <span class="dv">1</span>  <span class="ot">open</span> Nodejs
 <span class="dv">2</span>  
 <span class="dv">3</span>  <span class="ot">module</span> U = Yojson<span class="kw">.</span>Basic<span class="kw">.</span><span class="dt">Util</span>
 <span class="dv">4</span>  
 <span class="dv">5</span>  <span class="kw">let</span> (multicast_addr, bind_addr, port) = <span class="st">&quot;224.1.1.1&quot;</span>, <span class="st">&quot;0.0.0.0&quot;</span>, <span class="dv">6811</span>
 <span class="dv">6</span>  
 <span class="dv">7</span>  <span class="kw">let</span> () =
 <span class="dv">8</span>    Random<span class="kw">.</span>self_init ();
 <span class="dv">9</span>    <span class="kw">let</span> p = <span class="kw">new</span> process <span class="kw">in</span>
<span class="dv">10</span>    <span class="kw">let</span> user_name = <span class="dt">ref</span> (Printf<span class="kw">.</span>sprintf <span class="st">&quot;User:%d&quot;</span> (Random<span class="kw">.</span><span class="dt">int</span> <span class="dv">10000</span>)) <span class="kw">in</span>
<span class="dv">11</span>    <span class="kw">let</span> listener = Udp_datagram<span class="kw">.</span>(create_socket ~reuse_address:<span class="kw">true</span> <span class="dt">Udp4</span>) <span class="kw">in</span>
<span class="dv">12</span>    <span class="kw">let</span> sender = Udp_datagram<span class="kw">.</span>(create_socket ~reuse_address:<span class="kw">true</span> <span class="dt">Udp4</span>) <span class="kw">in</span>
<span class="dv">13</span>  
<span class="dv">14</span>    listener#bind ~port ~address:multicast_addr ~f:<span class="kw">begin</span> <span class="kw">fun</span> () -&gt;
<span class="dv">15</span>      listener#add_membership multicast_addr;
<span class="dv">16</span>      listener#set_broadcast <span class="kw">true</span>;
<span class="dv">17</span>      listener#set_multicast_loopback <span class="kw">true</span>
<span class="dv">18</span>    <span class="kw">end</span> ();
<span class="dv">19</span>  
<span class="dv">20</span>  
<span class="dv">21</span>    listener#on_message <span class="kw">begin</span> <span class="kw">fun</span> b resp -&gt;
<span class="dv">22</span>  
<span class="dv">23</span>      <span class="kw">let</span> handle = b#to_string () |&gt; json_of_string <span class="kw">in</span>
<span class="dv">24</span>      <span class="kw">if</span> (handle &lt;!&gt; <span class="st">&quot;id&quot;</span> |&gt; Js<span class="kw">.</span>to_string) &lt;&gt; !user_name
<span class="dv">25</span>      <span class="kw">then</span> print_string (handle &lt;!&gt; <span class="st">&quot;message&quot;</span> |&gt; Js<span class="kw">.</span>to_string)
<span class="dv">26</span>  
<span class="dv">27</span>    <span class="kw">end</span>;
<span class="dv">28</span>  
<span class="dv">29</span>    p#stdin#on_data <span class="kw">begin</span> <span class="kw">function</span>
<span class="dv">30</span>      | <span class="dt">String</span> _ -&gt; ()
<span class="dv">31</span>      | <span class="dt">Buffer</span> b -&gt;
<span class="dv">32</span>        <span class="kw">let</span> msg = b#to_string () <span class="kw">in</span>
<span class="dv">33</span>        <span class="co">(* This needs to be redone with Re_pcre *)</span>
<span class="dv">34</span>        <span class="kw">if</span> String<span class="kw">.</span>length msg &gt; <span class="dv">10</span> <span class="kw">then</span> <span class="kw">begin</span>
<span class="dv">35</span>          <span class="kw">let</span> modify = String<span class="kw">.</span>sub msg <span class="dv">0</span> <span class="dv">9</span> <span class="kw">in</span>
<span class="dv">36</span>          <span class="kw">if</span> modify = <span class="st">&quot;set name:&quot;</span>
<span class="dv">37</span>          <span class="kw">then</span> <span class="kw">begin</span>
<span class="dv">38</span>            <span class="kw">let</span> as_string = Js<span class="kw">.</span><span class="dt">string</span> (String<span class="kw">.</span>trim msg) <span class="kw">in</span>
<span class="dv">39</span>            <span class="kw">let</span> chopped =
<span class="dv">40</span>              as_string##split (Js<span class="kw">.</span><span class="dt">string</span> <span class="st">&quot;:&quot;</span>) |&gt; to_string_list |&gt; Array<span class="kw">.</span>of_list
<span class="dv">41</span>            <span class="kw">in</span>
<span class="dv">42</span>            user_name := chopped.(<span class="dv">1</span>)
<span class="dv">43</span>          <span class="kw">end</span>
<span class="dv">44</span>        <span class="kw">end</span>;
<span class="dv">45</span>  
<span class="dv">46</span>        <span class="kw">let</span> msg = Printf<span class="kw">.</span>sprintf <span class="st">&quot;%s&gt;&gt;&gt;%s&quot;</span> !user_name (b#to_string ()) <span class="kw">in</span>
<span class="dv">47</span>        <span class="kw">let</span> total_message = (<span class="kw">object</span>%js
<span class="dv">48</span>          <span class="kw">val</span> id = !user_name |&gt; to_js_str
<span class="dv">49</span>          <span class="kw">val</span> message = msg |&gt; to_js_str
<span class="dv">50</span>          <span class="kw">end</span>) |&gt; stringify
<span class="dv">51</span>        <span class="kw">in</span>
<span class="dv">52</span>        sender#send
<span class="dv">53</span>          ~offset:<span class="dv">0</span>
<span class="dv">54</span>          ~length:(String<span class="kw">.</span>length total_message)
<span class="dv">55</span>          ~port
<span class="dv">56</span>          ~dest_address:multicast_addr
<span class="dv">57</span>          (<span class="dt">String</span> total_message)
<span class="dv">58</span>      <span class="kw">end</span></code></pre></div>
<p><strong>Create a site and render directly from jade templates</strong></p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="ot">open</span> Nodejs

<span class="kw">let</span> () =
  <span class="kw">let</span> exp = <span class="kw">new</span> Express<span class="kw">.</span>express <span class="kw">in</span>
  <span class="kw">let</span> app = <span class="kw">new</span> Express<span class="kw">.</span>app ~existing:<span class="dt">None</span> <span class="kw">in</span>

  app#set_app_value (<span class="dt">`View_engine</span> <span class="st">&quot;jade&quot;</span>);
  app#use (exp#static <span class="st">&quot;.&quot;</span>);
  app#get ~path:<span class="st">&quot;/&quot;</span> (<span class="kw">fun</span> _ res -&gt; res#render <span class="st">&quot;index.jade&quot;</span>);

  app#listen ~port:<span class="dv">8080</span></code></pre></div>
<p><strong>Create a raw server from the Net module</strong></p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="kw">let</span> () =
  <span class="kw">let</span> server = Net<span class="kw">.</span>create_server ~conn_listener:<span class="kw">begin</span> <span class="kw">fun</span> sock -&gt;
      sock#on_end (<span class="kw">fun</span> () -&gt; print_endline <span class="st">&quot;client disconnected&quot;</span>);
      sock#write <span class="st">&quot;Hello</span><span class="ch">\r\n</span><span class="st">&quot;</span>;
      sock &gt;|&gt; sock |&gt; ignore
    <span class="kw">end</span> ()
  <span class="kw">in</span>
  server#listen ~port:<span class="dv">8124</span> <span class="kw">begin</span> <span class="kw">fun</span> () -&gt;
    <span class="kw">let</span> info = server#address <span class="kw">in</span>
    print_endline info.Net<span class="kw">.</span>address;
    print_endline (info.Net<span class="kw">.</span>ip_family |&gt; string_of_ip);
    print_endline (info.Net<span class="kw">.</span>port |&gt; string_of_int);
    print_endline <span class="st">&quot;started server&quot;</span>
  <span class="kw">end</span></code></pre></div>
<p><strong>Create a file stream, gzip it, write it</strong></p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="dv">1</span>  <span class="ot">open</span> Nodejs
<span class="dv">2</span>  
<span class="dv">3</span>  <span class="kw">let</span> _ =
<span class="dv">4</span>    Fs<span class="kw">.</span>create_read_stream <span class="st">&quot;code.ml&quot;</span> &gt;|&gt;
<span class="dv">5</span>    Zlib<span class="kw">.</span>create_gzip () &gt;|&gt;
<span class="dv">6</span>    Fs<span class="kw">.</span>create_write_stream <span class="st">&quot;NEWCODE_TEST.ml&quot;</span></code></pre></div>
<p><strong>Typed Decoding of Buffers</strong></p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="ot">open</span> Nodejs

<span class="kw">let</span> () =
  <span class="kw">let</span> string_decoder = <span class="kw">new</span> String_decoder<span class="kw">.</span>decoder <span class="dt">Utf_8</span> <span class="kw">in</span>
  <span class="kw">let</span> cent = <span class="kw">new</span> Buffer<span class="kw">.</span>buffer (<span class="dt">`Array</span> [|<span class="bn">0xE2</span>; <span class="bn">0x82</span>; <span class="bn">0xAC</span>|]) <span class="kw">in</span>
  (string_decoder#write cent) |&gt; print_endline</code></pre></div>
<p>This one is a bit more low level as it its a general idea of how these bindings are implemented.</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"> <span class="dv">1</span>  <span class="co">(* Assume this file is called c.ml *)</span>
 <span class="dv">2</span>  <span class="ot">open</span> Nodejs
 <span class="dv">3</span>  
 <span class="dv">4</span>  <span class="kw">class</span> child_process = <span class="kw">object</span>
 <span class="dv">5</span>  
 <span class="dv">6</span>    <span class="kw">val</span> raw_js = require_module <span class="st">&quot;child_process&quot;</span>
 <span class="dv">7</span>  
 <span class="dv">8</span>    <span class="co">(* Clearly not finished *)</span>
 <span class="dv">9</span>    <span class="kw">method</span> spawn_sync cmd args : (<span class="dt">string</span> * <span class="dt">string</span>) <span class="dt">list</span> =
<span class="dv">10</span>      <span class="kw">let</span> handle =
<span class="dv">11</span>        [|i (Js<span class="kw">.</span><span class="dt">string</span> cmd);
<span class="dv">12</span>          i (List<span class="kw">.</span>map Js<span class="kw">.</span><span class="dt">string</span> args |&gt; Array<span class="kw">.</span>of_list |&gt; Js<span class="kw">.</span><span class="dt">array</span>)|]
<span class="dv">13</span>        |&gt; m raw_js <span class="st">&quot;spawnSync&quot;</span>
<span class="dv">14</span>      <span class="kw">in</span>
<span class="dv">15</span>      (handle &lt;!&gt; <span class="st">&quot;envPairs&quot;</span>)
<span class="dv">16</span>      |&gt; Js<span class="kw">.</span>to_array |&gt; Array<span class="kw">.</span>map <span class="kw">begin</span> <span class="kw">fun</span> (s : Js<span class="kw">.</span>js_string Js<span class="kw">.</span>t) -&gt;
<span class="dv">17</span>        <span class="kw">let</span> chop = s##split (Js<span class="kw">.</span><span class="dt">string</span> <span class="st">&quot;=&quot;</span>) |&gt; to_string_list |&gt; Array<span class="kw">.</span>of_list <span class="kw">in</span>
<span class="dv">18</span>        (chop.(<span class="dv">0</span>), chop.(<span class="dv">1</span>))
<span class="dv">19</span>      <span class="kw">end</span>
<span class="dv">20</span>      |&gt; Array<span class="kw">.</span>to_list
<span class="dv">21</span>  
<span class="dv">22</span>  <span class="kw">end</span>
<span class="dv">23</span>  
<span class="dv">24</span>  <span class="kw">let</span> () =
<span class="dv">25</span>    <span class="kw">let</span> ls_proc = (<span class="kw">new</span> child_process)#spawn_sync <span class="st">&quot;ls&quot;</span> [] <span class="kw">in</span>
<span class="dv">26</span>    ls_proc |&gt; List<span class="kw">.</span>iter <span class="kw">begin</span> <span class="kw">fun</span> (key, value) -&gt;
<span class="dv">27</span>      Printf<span class="kw">.</span>sprintf <span class="st">&quot;Key was: %s and value: %s&quot;</span> key value
<span class="dv">28</span>      |&gt; print_endline
<span class="dv">29</span>    <span class="kw">end</span></code></pre></div>
<p>(Line one comes from my <code>nodejs</code> package, install it with <code>opam install nodejs</code>).</p>
<p>This example is a subset of my bindings to the builtin node module, <a href="https://nodejs.org/api/child_process.html">child_process</a>. Here we spawn a separate process and create an OCaml <code>alist</code> out of the environment variables of the spawned process. A point of interest is the poverty of OCaml StdLib’s <code>String</code> module, so much so that I get more functionality out of JavaScript’s string methods! (There’s no split in the StdLib).</p>
<p>To actually run this code you’ll need to do:</p>
<pre class="shell"><code>$ ocamlfind ocamlc c.ml -linkpkg -package nodejs -o T.out
$ js_of_ocaml T.out
$ node T.js</code></pre>
<h1 id="projects">Projects</h1>
<p>This approach surprisingly works and I’ve written similar bindings to <a href="https://github.com/fxfactorial/ocaml-npm-socket-io">socket.io</a> for which I have a working chat server:</p>
<div class="sourceCode"><pre class="sourceCode ocaml"><code class="sourceCode ocaml"><span class="ot">open</span> Nodejs

<span class="kw">let</span> () =
  <span class="kw">let</span> io = Socket_io<span class="kw">.</span>require () <span class="kw">in</span>
  <span class="kw">let</span> server =
    Http<span class="kw">.</span>create_server <span class="kw">begin</span> <span class="kw">fun</span> incoming response -&gt;

      Fs<span class="kw">.</span>read_file ~path:<span class="st">&quot;./client.html&quot;</span> <span class="kw">begin</span> <span class="kw">fun</span> err data -&gt;
        response#write_head ~status_code:<span class="dv">200</span> [(<span class="st">&quot;Content-type&quot;</span>, <span class="st">&quot;text/html&quot;</span>)];
        response#end_ ~data:(Http<span class="kw">.</span><span class="dt">String</span> data) ()

      <span class="kw">end</span>
    <span class="kw">end</span>
  <span class="kw">in</span>
  <span class="kw">let</span> app = server#listen ~port:<span class="dv">8080</span> <span class="kw">begin</span> <span class="kw">fun</span> () -&gt;
      Printf<span class="kw">.</span>sprintf
        <span class="st">&quot;Started Server and Running node: %s&quot;</span> (<span class="kw">new</span> process#version)
      |&gt; print_endline
    <span class="kw">end</span>
  <span class="kw">in</span>

  <span class="kw">let</span> io = io#listen app <span class="kw">in</span>
  io#sockets#on_connection <span class="kw">begin</span> <span class="kw">fun</span> socket -&gt;

    socket#on <span class="st">&quot;message_to_server&quot;</span> <span class="kw">begin</span> <span class="kw">fun</span> data -&gt;

      io#sockets#emit
        ~event_name:<span class="st">&quot;message_to_client&quot;</span>
        !!(<span class="kw">object</span>%js <span class="kw">val</span> message = data &lt;!&gt; <span class="st">&quot;message&quot;</span> <span class="kw">end</span>)

    <span class="kw">end</span>
  <span class="kw">end</span></code></pre></div>
<p>Notice the features of OCaml that don’t exist in JavaScript at all, like named parameters.</p>
<p>Another project in this vein are my bindings to Github’s <code>Electron</code> project, here’s a project I did with a friend using Basecamp’s recently released <code>Trix</code> editor.</p>
<div class="figure">
<img src="./electron_working.gif" alt="img" />
<p class="caption">img</p>
</div>
<h1 id="like-what-you-see">Like what you see?</h1>
<p>Writing out these bindings is a bit of work, Node’s API is pretty big in addition to third party code like socket.io, express, and Electron. Much of these bindings are quite formulaic, although some ideas don’t easily match up between the OCaml and JavaScript boundary, like <code>varargs</code> so that requires some more thought at times.</p>
<p>To any reader interested in OCaml open-source or for whatever reason, send me a PR, its mostly an issue of translating <a href="https://nodejs.org/api/index.html">the Node API</a> into the equivalent bindings:</p>
<p><a href="https://github.com/fxfactorial/ocaml-nodejs">nodejs repo</a></p>
<p><a href="https://github.com/fxfactorial/ocaml-electron">electron repo</a></p>
</article>


<footer>
    See older posts in the <a href="./archive/">archive</a>
</footer>

    </section>

    <footer id="page_footer">
    <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC-4.0</a>
    &mdash;
    Built with 
    <a href="http://jaspervdj.be/hakyll">Hakyll</a>.
    &mdash;
    Source on 
    <a href="https://github.com/fxfactorial/hblog">GitHub</a>
    &mdash;
    <a href="http://hyegar.com/atom.xml">RSS feed</a>
</footer>

  </body>
</html>
